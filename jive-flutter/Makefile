# Flutter é¡¹ç›®è‡ªåŠ¨åŒ–ä»»åŠ¡
# ç”¨äºæœ¬åœ°å¼€å‘ä½“éªŒä¼˜åŒ–
# åˆ›å»ºæ—¥æœŸ: 2025-09-20

.PHONY: help flutter-fix flutter-analyze flutter-test flutter-clean flutter-all setup-artifacts

# é»˜è®¤ç›®æ ‡ - æ˜¾ç¤ºå¸®åŠ©
help:
	@echo "Flutter é¡¹ç›® Makefile å‘½ä»¤:"
	@echo "  make flutter-fix      - åº”ç”¨è‡ªåŠ¨ä¿®å¤ (dart fix --apply)"
	@echo "  make flutter-analyze  - è¿è¡Œåˆ†æå¹¶ä¿å­˜æŠ¥å‘Š"
	@echo "  make flutter-test     - è¿è¡Œæµ‹è¯•å¹¶ä¿å­˜æŠ¥å‘Š"
	@echo "  make flutter-clean    - æ¸…ç†å¹¶é‡æ–°è·å–ä¾èµ–"
	@echo "  make flutter-all     - æ‰§è¡Œå®Œæ•´æµç¨‹: æ¸…ç†->ä¿®å¤->åˆ†æ->æµ‹è¯•"
	@echo "  make setup-artifacts  - åˆ›å»ºè¾“å‡ºç›®å½•"

# åˆ›å»ºè¾“å‡ºç›®å½•
setup-artifacts:
	@mkdir -p local-artifacts
	@echo "âœ… è¾“å‡ºç›®å½• local-artifacts/ å·²åˆ›å»º"

# åº”ç”¨è‡ªåŠ¨ä¿®å¤
flutter-fix: setup-artifacts
	@echo "ğŸ”§ æ­£åœ¨åº”ç”¨è‡ªåŠ¨ä¿®å¤..."
	@dart fix --apply | tee local-artifacts/dart-fix-$(shell date +%Y%m%d-%H%M%S).log
	@echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ"

# è¿è¡Œåˆ†æå¹¶ä¿å­˜æŠ¥å‘Š
flutter-analyze: setup-artifacts
	@echo "ğŸ“Š æ­£åœ¨è¿è¡Œ Flutter åˆ†æ..."
	@flutter analyze | tee local-artifacts/flutter-analyze.txt
	@echo "âœ… åˆ†æå®Œæˆï¼ŒæŠ¥å‘Šå·²ä¿å­˜åˆ° local-artifacts/flutter-analyze.txt"
	@echo "ğŸ“ˆ é”™è¯¯ç»Ÿè®¡:"
	@echo "  Errors: $$(grep -c '^  error ' local-artifacts/flutter-analyze.txt || echo 0)"
	@echo "  Warnings: $$(grep -c '^warning ' local-artifacts/flutter-analyze.txt || echo 0)"
	@echo "  Info: $$(grep -c '^   info ' local-artifacts/flutter-analyze.txt || echo 0)"

# è¿è¡Œæµ‹è¯•å¹¶ä¿å­˜æŠ¥å‘Š
flutter-test: setup-artifacts
	@echo "ğŸ§ª æ­£åœ¨è¿è¡Œæµ‹è¯•..."
	@flutter test -r expanded | tee local-artifacts/flutter-tests.txt || true
	@echo "âœ… æµ‹è¯•å®Œæˆï¼ŒæŠ¥å‘Šå·²ä¿å­˜åˆ° local-artifacts/flutter-tests.txt"

# æ¸…ç†å¹¶é‡æ–°è·å–ä¾èµ–
flutter-clean:
	@echo "ğŸ§¹ æ¸…ç†é¡¹ç›®..."
	@flutter clean
	@echo "ğŸ“¦ é‡æ–°è·å–ä¾èµ–..."
	@flutter pub get
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å®Œæ•´æµç¨‹
flutter-all: flutter-clean flutter-fix flutter-analyze flutter-test
	@echo "ğŸ‰ æ‰€æœ‰ä»»åŠ¡å®Œæˆ!"
	@echo "ğŸ“ æŸ¥çœ‹æŠ¥å‘Š: ls -la local-artifacts/"

# å¿«é€Ÿæ£€æŸ¥ - åªè¿è¡Œåˆ†æ
quick-check: flutter-analyze
	@echo "âœ… å¿«é€Ÿæ£€æŸ¥å®Œæˆ"

# ç”Ÿæˆåˆ†æ JSON æŠ¥å‘Šï¼ˆç”¨äºå·¥å…·é›†æˆï¼‰
analyze-json: setup-artifacts
	@echo "ğŸ“Š ç”Ÿæˆ JSON æ ¼å¼åˆ†ææŠ¥å‘Š..."
	@dart analyze --format=json > local-artifacts/flutter-analyze.json 2>&1 || true
	@echo "âœ… JSON æŠ¥å‘Šå·²ä¿å­˜åˆ° local-artifacts/flutter-analyze.json"

# ç»Ÿè®¡é—®é¢˜æ•°é‡
stats:
	@echo "ğŸ“Š å½“å‰é—®é¢˜ç»Ÿè®¡:"
	@flutter analyze --no-pub 2>&1 | grep -E "^Analyzing|error |warning |   info " | tail -5

# æ¸…ç†ç”Ÿæˆçš„æŠ¥å‘Š
clean-artifacts:
	@rm -rf local-artifacts/
	@echo "ğŸ§¹ æŠ¥å‘Šæ–‡ä»¶å·²æ¸…ç†"