# æ‰‹åŠ¨æ±‡ç‡é—®é¢˜è¯Šæ–­æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-11
**é—®é¢˜1**: æ‰‹åŠ¨è®¾ç½®çš„æ±‡ç‡ä¸å‡ºç°åœ¨æ¸…å•ä¸­
**é—®é¢˜2**: åˆ°æœŸæ—¶é—´èƒ½å¦ç²¾ç¡®åˆ°åˆ†é’Ÿ

---

## ğŸ” æ ¸å¿ƒå‘ç°

### é—®é¢˜1ï¼šæ‰‹åŠ¨æ±‡ç‡ä¸ºä»€ä¹ˆä¸ä¿å­˜ï¼Ÿ

**å…³é”®å‘ç°**: æ—§çš„æ‰‹åŠ¨æ±‡ç‡è®¾ç½®UIå·²è¢«ç¦ç”¨ï¼

**æ–‡ä»¶**: `lib/screens/management/currency_management_page_v2.dart`
**ä½ç½®**: Line 313

```dart
// 5. æ±‡ç‡ç®¡ç†ï¼ˆéšè—ï¼‰
if (false)  // â† æ•´ä¸ªæ±‡ç‡ç®¡ç†åŒºåŸŸè¢«ç¦ç”¨ï¼
  Container(
    // ... åŒ…å«"æ‰‹åŠ¨è®¾ç½®"æŒ‰é’®çš„ä»£ç 
  )
```

è¿™æ„å‘³ç€ï¼š
- âŒ ç”¨æˆ·æ— æ³•é€šè¿‡UIç‚¹å‡»"æ‰‹åŠ¨è®¾ç½®"æŒ‰é’®
- âŒ å³ä½¿é€šè¿‡URLç›´æ¥è®¿é—®ï¼Œè¯¥åŠŸèƒ½ä¹Ÿä¸å¯è§
- âœ… **æ‰‹åŠ¨æ±‡ç‡è¦†ç›–æ¸…å•é¡µé¢**å¯ä»¥è®¿é—®ï¼ˆæ‚¨å·²ç»æ‰¾åˆ°çš„å…¥å£ï¼‰

---

## ğŸ“Š å½“å‰çŠ¶æ€éªŒè¯

### æ•°æ®åº“æ£€æŸ¥ç»“æœ
```sql
SELECT * FROM exchange_rates WHERE is_manual = true;
```
**ç»“æœ**: 0 rows - æ•°æ®åº“ä¸­æ²¡æœ‰æ‰‹åŠ¨æ±‡ç‡

### APIç«¯ç‚¹æµ‹è¯•ç»“æœ
```bash
curl -X POST http://localhost:8012/api/v1/currencies/rates/add
```
**ç»“æœ**: `{"error":"Missing credentials"}` - APIéœ€è¦è®¤è¯ä½†ç«¯ç‚¹å­˜åœ¨

### ä»£ç æµç¨‹åˆ†æ

#### âœ… åç«¯APIæ”¯æŒ (å®Œæ•´)
- **æ–‡ä»¶**: `jive-api/src/services/currency_service.rs:372-427`
- **ç«¯ç‚¹**: `POST /api/v1/currencies/rates/add`
- **åŠŸèƒ½**: å®Œå…¨æ”¯æŒæ‰‹åŠ¨æ±‡ç‡ä¿å­˜
- **æ—¶é—´ç²¾åº¦**: âœ… æ”¯æŒåˆ°åˆ†é’Ÿçº§åˆ« (`manual_rate_expiry: Option<DateTime<Utc>>`)

#### âœ… Flutter Provideræ”¯æŒ (å®Œæ•´)
- **æ–‡ä»¶**: `lib/providers/currency_provider.dart:475-514`
- **æ–¹æ³•**: `setManualRatesWithExpiries()`
- **åŠŸèƒ½**:
  - ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ (Hive)
  - è°ƒç”¨APIæŒä¹…åŒ–åˆ°æ•°æ®åº“
  - æ”¯æŒæ¯ä¸ªè´§å¸ç‹¬ç«‹è¿‡æœŸæ—¶é—´

```dart
// ä»£ç ä¼šè°ƒç”¨ API
await dio.post('/currencies/rates/add', data: {
  'from_currency': state.baseCurrency,
  'to_currency': code,
  'rate': rate,
  'source': 'manual',
  if (expiry != null) 'manual_rate_expiry': expiry.toIso8601String(),
});
```

#### âŒ å‰ç«¯UIç¼ºå¤± (å…³é”®é—®é¢˜)
- **æ–‡ä»¶**: `lib/screens/management/currency_management_page_v2.dart`
- **é—®é¢˜**: Line 313 çš„ `if (false)` ç¦ç”¨äº†æ•´ä¸ª"æ±‡ç‡ç®¡ç†"åŒºåŸŸ
- **å½±å“**: ç”¨æˆ·æ— æ³•é€šè¿‡UIè®¾ç½®æ–°çš„æ‰‹åŠ¨æ±‡ç‡

---

## ğŸ¯ é—®é¢˜2ï¼šæ—¶é—´ç²¾ç¡®åº¦

### å½“å‰å®ç°

**æ•°æ®åº“**: âœ… æ”¯æŒåˆ†é’Ÿç²¾åº¦
```sql
manual_rate_expiry timestamp with time zone
```

**åç«¯API**: âœ… æ”¯æŒåˆ†é’Ÿç²¾åº¦
```rust
pub manual_rate_expiry: Option<chrono::DateTime<chrono::Utc>>
```

**Flutter UI**: âŒ **ä»…æ”¯æŒæ—¥æœŸ** (Lines 470-481)
```dart
final date = await showDatePicker(
  context: context,
  initialDate: expiryUtc.toLocal(),
  firstDate: DateTime.now(),
  lastDate: DateTime.now().add(const Duration(days: 60)),
);
if (date != null) {
  setState(() {
    expiryUtc = DateTime.utc(
        date.year, date.month, date.day, 0, 0, 0);  // â† å›ºå®šä¸º 00:00:00
  });
}
```

**ç»“è®º**:
- âœ… åç«¯å’Œæ•°æ®åº“**å®Œå…¨æ”¯æŒåˆ†é’Ÿçº§ç²¾åº¦**
- âŒ å‰ç«¯UI**åªå®ç°äº†æ—¥æœŸé€‰æ‹©å™¨**ï¼Œæ—¶é—´å›ºå®šä¸º 00:00:00 UTC

---

## ğŸ’¡ æ ¹æœ¬åŸå› æ€»ç»“

### ä¸ºä»€ä¹ˆæ‰‹åŠ¨æ±‡ç‡ä¸ä¿å­˜ï¼Ÿ

1. **æ—§UIè¢«ç¦ç”¨**:
   - ç”¨æˆ·è¯´"æˆ‘åˆšæ‰‹å·¥è®¾ç½®äº†ä¸€ä¸ªæ‰‹åŠ¨æ±‡ç‡"
   - ä½†ä»£ç ä¸­çš„æ‰‹åŠ¨è®¾ç½®UIè¢« `if (false)` ç¦ç”¨
   - å¯èƒ½ç”¨æˆ·é€šè¿‡å…¶ä»–æ–¹å¼å°è¯•è®¾ç½®ï¼ˆæµè§ˆå™¨ç¼“å­˜çš„æ—§é¡µé¢ï¼Ÿï¼‰

2. **æ–°UIåŠŸèƒ½ä¸å®Œæ•´**:
   - æ–°çš„ `ManualOverridesPage` åªèƒ½**æŸ¥çœ‹å’Œæ¸…é™¤**ç°æœ‰æ‰‹åŠ¨æ±‡ç‡
   - **æ²¡æœ‰"æ·»åŠ æ–°æ‰‹åŠ¨æ±‡ç‡"çš„åŠŸèƒ½**

3. **åŠŸèƒ½è¿ç§»æœªå®Œæˆ**:
   - æ—§çš„æ‰‹åŠ¨è®¾ç½®åŠŸèƒ½è¢«ç¦ç”¨
   - æ–°çš„æ‰‹åŠ¨è¦†ç›–é¡µé¢åªå®ç°äº†æŸ¥çœ‹åŠŸèƒ½
   - å¯¼è‡´ç”¨æˆ·æ— æ³•é€šè¿‡ä»»ä½•UIè®¾ç½®æ‰‹åŠ¨æ±‡ç‡

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šåœ¨ ManualOverridesPage æ·»åŠ "æ–°å¢æ‰‹åŠ¨æ±‡ç‡"åŠŸèƒ½ (æ¨è)

**ä¼˜ç‚¹**:
- ç¬¦åˆå½“å‰æ¶æ„ï¼ˆä¸“é—¨çš„æ‰‹åŠ¨æ±‡ç‡ç®¡ç†é¡µé¢ï¼‰
- åŠŸèƒ½é›†ä¸­ï¼Œæ˜“äºç»´æŠ¤
- å¯ä»¥æ”¯æŒæ—¶é—´é€‰æ‹©å™¨

**å®ç°æ­¥éª¤**:
1. åœ¨ `ManualOverridesPage` æ·»åŠ  FAB (FloatingActionButton) "æ·»åŠ æ‰‹åŠ¨æ±‡ç‡"
2. å¼¹å‡ºå¯¹è¯æ¡†è®©ç”¨æˆ·é€‰æ‹©ï¼š
   - ç›®æ ‡è´§å¸
   - æ±‡ç‡æ•°å€¼
   - è¿‡æœŸæ—¥æœŸ
   - **è¿‡æœŸæ—¶é—´** (æ–°å¢)
3. è°ƒç”¨ `currency_provider` çš„ `setManualRatesWithExpiries` æ–¹æ³•
4. åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºæ–°æ·»åŠ çš„æ‰‹åŠ¨æ±‡ç‡

### æ–¹æ¡ˆBï¼šé‡æ–°å¯ç”¨æ—§çš„æ‰‹åŠ¨è®¾ç½®æŒ‰é’®

**ä¼˜ç‚¹**:
- ä»£ç å·²å­˜åœ¨ï¼Œå¿«é€Ÿæ¢å¤
- ç”¨æˆ·ç†Ÿæ‚‰çš„æµç¨‹

**ç¼ºç‚¹**:
- æ—§UIå¯èƒ½æœ‰è®¾è®¡é—®é¢˜ï¼ˆè¢«ç¦ç”¨çš„åŸå› ï¼‰
- ä¸ç¬¦åˆå½“å‰æ¶æ„æ–¹å‘

---

## ğŸ“‹ æ—¶é—´ç²¾åº¦æ”¹è¿›æ–¹æ¡ˆ

### åœ¨ `_promptManualRateWithExpiry` æ·»åŠ æ—¶é—´é€‰æ‹©å™¨

**ä¿®æ”¹æ–‡ä»¶**: `lib/screens/management/currency_management_page_v2.dart`
**ä¿®æ”¹ä½ç½®**: Lines 470-481

**å½“å‰ä»£ç ** (åªæœ‰æ—¥æœŸ):
```dart
final date = await showDatePicker(
  context: context,
  initialDate: expiryUtc.toLocal(),
  firstDate: DateTime.now(),
  lastDate: DateTime.now().add(const Duration(days: 60)),
);
if (date != null) {
  setState(() {
    expiryUtc = DateTime.utc(
        date.year, date.month, date.day, 0, 0, 0);
  });
}
```

**æ”¹è¿›ä»£ç ** (æ—¥æœŸ + æ—¶é—´):
```dart
// 1. é€‰æ‹©æ—¥æœŸ
final date = await showDatePicker(
  context: context,
  initialDate: expiryUtc.toLocal(),
  firstDate: DateTime.now(),
  lastDate: DateTime.now().add(const Duration(days: 60)),
);
if (date != null) {
  // 2. é€‰æ‹©æ—¶é—´
  final time = await showTimePicker(
    context: context,
    initialTime: TimeOfDay.fromDateTime(expiryUtc.toLocal()),
  );
  if (time != null) {
    setState(() {
      expiryUtc = DateTime.utc(
        date.year,
        date.month,
        date.day,
        time.hour,     // â† ç”¨æˆ·é€‰æ‹©çš„å°æ—¶
        time.minute,   // â† ç”¨æˆ·é€‰æ‹©çš„åˆ†é’Ÿ
        0,             // ç§’å›ºå®šä¸º0
      );
    });
  } else {
    // ç”¨æˆ·å–æ¶ˆæ—¶é—´é€‰æ‹©ï¼Œä½¿ç”¨é»˜è®¤ 00:00
    setState(() {
      expiryUtc = DateTime.utc(
        date.year, date.month, date.day, 0, 0, 0);
    });
  }
}
```

---

## ğŸ¯ æ¨èè¡ŒåŠ¨æ–¹æ¡ˆ

### ç«‹å³è¡ŒåŠ¨ (è§£å†³é—®é¢˜1)

**é€‰é¡¹1: å¿«é€Ÿæ¢å¤æ—§åŠŸèƒ½**
```dart
// æ–‡ä»¶: currency_management_page_v2.dart:313
// æ”¹ä¸º: if (true)
if (true)  // â† ä» false æ”¹ä¸º true
  Container(
    // æ±‡ç‡ç®¡ç†UI...
  )
```

**é€‰é¡¹2: å®Œå–„æ–°åŠŸèƒ½** (æ›´å¥½ä½†éœ€è¦æ›´å¤šå·¥ä½œ)
1. åœ¨ `ManualOverridesPage` æ·»åŠ "æ–°å¢æ‰‹åŠ¨æ±‡ç‡"æŒ‰é’®
2. å®ç°æ·»åŠ å¯¹è¯æ¡†ï¼ˆå‚è€ƒç°æœ‰çš„ `_promptManualRateWithExpiry` ä»£ç ï¼‰
3. æ”¯æŒæ—¶é—´é€‰æ‹©å™¨ï¼ˆè§£å†³é—®é¢˜2ï¼‰

### æ”¹è¿›æ—¶é—´ç²¾åº¦ (è§£å†³é—®é¢˜2)

**å®æ–½**: åœ¨ `_promptManualRateWithExpiry` æ–¹æ³•ä¸­æ·»åŠ  `showTimePicker`
**ä½ç½®**: `currency_management_page_v2.dart:470-481`
**ä¼˜å…ˆçº§**: ä¸­ç­‰ï¼ˆå¯ä»¥åœ¨è§£å†³é—®é¢˜1åå†å¤„ç†ï¼‰

---

## ğŸ”„ éªŒè¯æ­¥éª¤

### æ¢å¤åŠŸèƒ½åçš„æµ‹è¯•

1. **è®¿é—®æ‰‹åŠ¨è®¾ç½®å…¥å£**:
   ```
   http://localhost:3021/#/settings/currency
   â†’ å¯ç”¨å¤šå¸ç§
   â†’ ç‚¹å‡»"æ‰‹åŠ¨è®¾ç½®"æŒ‰é’®ï¼ˆæ¢å¤ååº”è¯¥å¯è§ï¼‰
   ```

2. **è®¾ç½®æ‰‹åŠ¨æ±‡ç‡**:
   - é€‰æ‹©ç›®æ ‡è´§å¸ (å¦‚ CNY)
   - è¾“å…¥æ±‡ç‡ (å¦‚ 7.25)
   - é€‰æ‹©è¿‡æœŸæ—¥æœŸ

3. **éªŒè¯ä¿å­˜**:
   ```sql
   -- æ•°æ®åº“æ£€æŸ¥
   SELECT from_currency, to_currency, rate, is_manual,
          manual_rate_expiry, created_at
   FROM exchange_rates
   WHERE is_manual = true;
   ```

4. **éªŒè¯æ˜¾ç¤º**:
   ```
   è®¿é—®: http://localhost:3021/#/settings/currency/manual-overrides
   â†’ åº”è¯¥èƒ½çœ‹åˆ°åˆšè®¾ç½®çš„æ‰‹åŠ¨æ±‡ç‡
   ```

---

## ğŸ“Š æŠ€æœ¯æ ˆå®Œæ•´æ€§è¯„ä¼°

| ç»„ä»¶ | æ”¯æŒæ‰‹åŠ¨æ±‡ç‡ | æ”¯æŒåˆ†é’Ÿç²¾åº¦ | çŠ¶æ€ |
|------|------------|------------|------|
| **PostgreSQLæ•°æ®åº“** | âœ… | âœ… | æ­£å¸¸ |
| **Rust APIåç«¯** | âœ… | âœ… | æ­£å¸¸ |
| **Flutter Provider** | âœ… | âœ… | æ­£å¸¸ |
| **Flutter UI (æ—§)** | âŒ (è¢«ç¦ç”¨) | âŒ (ä»…æ—¥æœŸ) | **éœ€ä¿®å¤** |
| **Flutter UI (æ–°)** | âŒ (ä»…æŸ¥çœ‹) | N/A | **éœ€æ·»åŠ ** |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### å¯¹ç”¨æˆ·

**ç«‹å³å¯è¡Œ**:
1. æˆ‘å¯ä»¥å¸®æ‚¨é‡æ–°å¯ç”¨æ—§çš„"æ‰‹åŠ¨è®¾ç½®"æŒ‰é’® (æ”¹ `if (false)` ä¸º `if (true)`)
2. è¿™æ ·æ‚¨å°±å¯ä»¥è®¾ç½®æ‰‹åŠ¨æ±‡ç‡äº†

**é•¿æœŸæ”¹è¿›**:
1. åœ¨ `ManualOverridesPage` æ·»åŠ "æ–°å¢"åŠŸèƒ½ï¼Œæ›¿ä»£æ—§UI
2. æ·»åŠ æ—¶é—´é€‰æ‹©å™¨ï¼Œæ”¯æŒç²¾ç¡®åˆ°åˆ†é’Ÿçš„è¿‡æœŸæ—¶é—´

### æ‚¨å¸Œæœ›æˆ‘ï¼š
- A. ç«‹å³æ¢å¤æ—§çš„æ‰‹åŠ¨è®¾ç½®åŠŸèƒ½ï¼Ÿ(å¿«é€Ÿ)
- B. åœ¨æ–°çš„æ‰‹åŠ¨è¦†ç›–é¡µé¢æ·»åŠ "æ–°å¢"åŠŸèƒ½ï¼Ÿ(æ›´å¥½ä½†éœ€è¦æ—¶é—´)
- C. ä¸¤è€…éƒ½åšï¼Ÿ

è¯·å‘Šè¯‰æˆ‘æ‚¨çš„é€‰æ‹©ï¼Œæˆ‘ä¼šç«‹å³å®æ–½ï¼

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-11
**è¯Šæ–­æ–¹å¼**: ä»£ç é™æ€åˆ†æ + æ•°æ®åº“éªŒè¯ + APIæµ‹è¯•
**çŠ¶æ€**: ç­‰å¾…ç”¨æˆ·é€‰æ‹©è§£å†³æ–¹æ¡ˆ
