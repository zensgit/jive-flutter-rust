# Jive Money åˆ†ç±»åŠŸèƒ½å®Œæ•´è®¾è®¡æ–‡æ¡£

## ç›®å½•
1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#3-æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
4. [æ•°æ®æ¨¡å‹](#4-æ•°æ®æ¨¡å‹)
5. [API æ¥å£](#5-api-æ¥å£)
6. [ç”¨æˆ·ç•Œé¢](#6-ç”¨æˆ·ç•Œé¢)
7. [ä¸šåŠ¡æµç¨‹](#7-ä¸šåŠ¡æµç¨‹)
8. [æŠ€æœ¯å®ç°](#8-æŠ€æœ¯å®ç°)
9. [éƒ¨ç½²æ–¹æ¡ˆ](#9-éƒ¨ç½²æ–¹æ¡ˆ)
10. [æµ‹è¯•è®¡åˆ’](#10-æµ‹è¯•è®¡åˆ’)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½
Jive Money åˆ†ç±»ç³»ç»Ÿæ˜¯ä¸€ä¸ªä¸‰å±‚æ¶æ„çš„è´¢åŠ¡åˆ†ç±»ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒç³»ç»Ÿé¢„è®¾ã€ç”¨æˆ·è‡ªå®šä¹‰å’Œçµæ´»è½¬æ¢ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼
- ğŸ“š **å®Œå–„çš„æ¨¡æ¿åº“**ï¼šæä¾› 50+ é¢„è®¾åˆ†ç±»æ¨¡æ¿
- ğŸ¯ **çµæ´»çš„ç®¡ç†**ï¼šæ”¯æŒè‡ªå®šä¹‰ã€å±‚çº§ã€æ‹–æ‹½æ’åº
- ğŸ”„ **æ™ºèƒ½è½¬æ¢**ï¼šåˆ†ç±»å¯è½¬æ¢ä¸ºæ ‡ç­¾
- ğŸ“Š **æ•°æ®æ´å¯Ÿ**ï¼šä½¿ç”¨ç»Ÿè®¡å’Œæ™ºèƒ½æ¨è

### 1.3 ç›®æ ‡ç”¨æˆ·
- **æ™®é€šç”¨æˆ·**ï¼šä½¿ç”¨åˆ†ç±»è®°è´¦ï¼Œç®¡ç†ä¸ªäººåˆ†ç±»
- **ç®¡ç†å‘˜**ï¼šç»´æŠ¤ç³»ç»Ÿæ¨¡æ¿ï¼ŒæŸ¥çœ‹ä½¿ç”¨ç»Ÿè®¡

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 ä¸‰å±‚åˆ†ç±»ä½“ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç¬¬ä¸€å±‚ï¼šç³»ç»Ÿåˆ†ç±»æ¨¡æ¿                â”‚
â”‚   - ç®¡ç†å‘˜ç»´æŠ¤                              â”‚
â”‚   - å…¨å±€å…±äº«                                â”‚
â”‚   - ç‰ˆæœ¬æ§åˆ¶                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ å¯¼å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç¬¬äºŒå±‚ï¼šç”¨æˆ·åˆ†ç±»                    â”‚
â”‚   - ä¸ªäººå®šåˆ¶                                â”‚
â”‚   - è´¦æœ¬éš”ç¦»                                â”‚
â”‚   - å±‚çº§ç®¡ç†                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ è½¬æ¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç¬¬ä¸‰å±‚ï¼šæ ‡ç­¾ç³»ç»Ÿ                    â”‚
â”‚   - çµæ´»æ ‡è®°                                â”‚
â”‚   - å¤šå¯¹å¤šå…³ç³»                              â”‚
â”‚   - è‡ªç”±ç»„åˆ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ¶æ„

```
å‰ç«¯ (Flutter)
    â”œâ”€â”€ åˆ†ç±»ç®¡ç†é¡µé¢
    â”œâ”€â”€ æ¨¡æ¿åº“æµè§ˆ
    â”œâ”€â”€ è½¬æ¢å¯¹è¯æ¡†
    â””â”€â”€ æ‰¹é‡æ“ä½œç•Œé¢
           â†“
API å±‚ (RESTful)
    â”œâ”€â”€ ç”¨æˆ· API
    â””â”€â”€ ç®¡ç† API
           â†“
æœåŠ¡å±‚ (Rust)
    â”œâ”€â”€ CategoryService
    â”œâ”€â”€ TemplateService
    â””â”€â”€ ConversionService
           â†“
æ•°æ®å±‚ (PostgreSQL)
    â”œâ”€â”€ system_category_templates
    â”œâ”€â”€ user_categories
    â””â”€â”€ category_batch_operations
```

---

## 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 3.1 ç³»ç»Ÿæ¨¡æ¿ç®¡ç†
| åŠŸèƒ½ | è¯´æ˜ | æƒé™ |
|-----|------|-----|
| æ¨¡æ¿ CRUD | åˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤æ¨¡æ¿ | ç®¡ç†å‘˜ |
| æ‰¹é‡å¯¼å…¥ | CSV/JSON æ‰¹é‡å¯¼å…¥æ¨¡æ¿ | ç®¡ç†å‘˜ |
| ç‰ˆæœ¬ç®¡ç† | æ¨¡æ¿ç‰ˆæœ¬æ§åˆ¶å’Œå‘å¸ƒ | ç®¡ç†å‘˜ |
| ä½¿ç”¨ç»Ÿè®¡ | æŸ¥çœ‹æ¨¡æ¿ä½¿ç”¨æƒ…å†µ | ç®¡ç†å‘˜ |
| æ¨¡æ¿æµè§ˆ | æŸ¥çœ‹å¯ç”¨æ¨¡æ¿ | æ‰€æœ‰ç”¨æˆ· |

### 3.2 ç”¨æˆ·åˆ†ç±»ç®¡ç†
| åŠŸèƒ½ | è¯´æ˜ | ç‰¹æ€§ |
|-----|------|-----|
| åˆ†ç±» CRUD | åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤åˆ†ç±» | æ”¯æŒè‡ªå®šä¹‰é¢œè‰²ã€å›¾æ ‡ |
| å±‚çº§ç®¡ç† | çˆ¶å­åˆ†ç±»å…³ç³» | æœ€å¤šä¸¤å±‚ |
| æ‹–æ‹½æ’åº | è°ƒæ•´åˆ†ç±»é¡ºåºå’Œå±‚çº§ | å®æ—¶ä¿å­˜ |
| æ¨¡æ¿å¯¼å…¥ | ä»ç³»ç»Ÿæ¨¡æ¿å¯¼å…¥ | æ”¯æŒæ‰¹é‡å’Œè‡ªå®šä¹‰ |
| ä½¿ç”¨ç»Ÿè®¡ | æŸ¥çœ‹åˆ†ç±»ä½¿ç”¨æ¬¡æ•° | ç‚¹å‡»æŸ¥çœ‹äº¤æ˜“æ˜ç»† |

### 3.3 åˆ†ç±»è½¬æ¢åŠŸèƒ½
| åŠŸèƒ½ | è¯´æ˜ | é€‰é¡¹ |
|-----|------|-----|
| è½¬ä¸ºæ ‡ç­¾ | åˆ†ç±»è½¬æ¢ä¸ºæ ‡ç­¾ | å¯é€‰åº”ç”¨åˆ°å†å²äº¤æ˜“ |
| åˆ†ç±»åˆå¹¶ | åˆå¹¶é‡å¤åˆ†ç±» | äº¤æ˜“è‡ªåŠ¨è¿ç§» |
| æ‰¹é‡é‡åˆ†ç±» | æ‰¹é‡æ›´æ”¹äº¤æ˜“åˆ†ç±» | æ”¯æŒæ’¤é”€ |
| åˆ é™¤éªŒè¯ | æœ‰äº¤æ˜“çš„åˆ†ç±»åˆ é™¤ç¡®è®¤ | æä¾›å¤šç§å¤„ç†æ–¹å¼ |

### 3.4 äº¤äº’å¢å¼ºåŠŸèƒ½
| åŠŸèƒ½ | è¯´æ˜ | ç”¨æˆ·ä½“éªŒ |
|-----|------|-----|
| äº¤æ˜“æ˜ç»†æŸ¥çœ‹ | ç‚¹å‡»æ•°é‡æŸ¥çœ‹åˆ†ç±»ä¸‹äº¤æ˜“ | æ”¯æŒç­›é€‰å’Œæ’åº |
| å¿«é€Ÿåˆ‡æ¢ | äº¤æ˜“è¯¦æƒ…é¡µå¿«é€Ÿæ›´æ”¹åˆ†ç±» | æœ€è¿‘ä½¿ç”¨ä¼˜å…ˆ |
| æ™ºèƒ½æ¨è | åŸºäºä½¿ç”¨ä¹ æƒ¯æ¨èåˆ†ç±» | è‡ªåŠ¨å­¦ä¹  |
| æ“ä½œæ’¤é”€ | æ”¯æŒæ’¤é”€æœ€è¿‘æ“ä½œ | 24å°æ—¶å†…æœ‰æ•ˆ |

---

## 4. æ•°æ®æ¨¡å‹

### 4.1 ç³»ç»Ÿåˆ†ç±»æ¨¡æ¿è¡¨
```sql
CREATE TABLE system_category_templates (
    id UUID PRIMARY KEY,
    -- åŸºç¡€ä¿¡æ¯
    name VARCHAR(100) NOT NULL,
    name_en VARCHAR(100),
    name_zh VARCHAR(100),
    description TEXT,
    
    -- åˆ†ç±»å±æ€§
    classification VARCHAR(20) NOT NULL, -- income/expense/transfer
    color VARCHAR(7) NOT NULL,           -- #RRGGBB
    icon VARCHAR(50),                    -- å›¾æ ‡æ ‡è¯†
    category_group VARCHAR(50),          -- æ‰€å±åˆ†ç»„
    
    -- å…ƒæ•°æ®
    version VARCHAR(20),
    is_active BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,   -- æ˜¯å¦æ¨è
    global_usage_count INTEGER DEFAULT 0,
    tags TEXT[],                         -- æ ‡ç­¾æ•°ç»„
    
    -- å®¡è®¡
    created_by UUID,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- ç´¢å¼•
    INDEX idx_group (category_group),
    INDEX idx_classification (classification),
    INDEX idx_featured (is_featured)
);
```

### 4.2 ç”¨æˆ·åˆ†ç±»è¡¨
```sql
CREATE TABLE user_categories (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    ledger_id UUID NOT NULL,
    
    -- åŸºç¡€ä¿¡æ¯
    name VARCHAR(100) NOT NULL,
    color VARCHAR(7) NOT NULL,
    icon VARCHAR(50),
    classification VARCHAR(20) NOT NULL,
    
    -- å±‚çº§å…³ç³»
    parent_id UUID REFERENCES user_categories(id),
    position INTEGER DEFAULT 0,          -- æ’åºä½ç½®
    
    -- æ¥æºè¿½è¸ª
    source_type VARCHAR(20),             -- system/custom
    template_id UUID REFERENCES system_category_templates(id),
    template_version VARCHAR(20),
    
    -- ç»Ÿè®¡
    usage_count INTEGER DEFAULT 0,
    last_used_at TIMESTAMP,
    
    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT true,
    is_deleted BOOLEAN DEFAULT false,
    deleted_at TIMESTAMP,
    
    -- å®¡è®¡
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- çº¦æŸå’Œç´¢å¼•
    UNIQUE INDEX idx_user_ledger_name (user_id, ledger_id, name),
    INDEX idx_parent (parent_id),
    INDEX idx_usage (usage_count DESC),
    INDEX idx_position (position)
);
```

### 4.3 åˆ†ç±»ç»„è¡¨
```sql
CREATE TABLE category_groups (
    id UUID PRIMARY KEY,
    key VARCHAR(50) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    name_en VARCHAR(100),
    name_zh VARCHAR(100),
    description TEXT,
    icon VARCHAR(50),
    display_order INTEGER,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_order (display_order)
);
```

### 4.4 æ‰¹é‡æ“ä½œè®°å½•è¡¨
```sql
CREATE TABLE category_batch_operations (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    operation_type VARCHAR(20) NOT NULL, -- recategorize/convert/merge
    original_data JSONB,                 -- åŸå§‹æ•°æ®å¿«ç…§
    affected_transactions INTEGER DEFAULT 0,
    can_revert BOOLEAN DEFAULT true,
    reverted_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,                -- 24å°æ—¶è¿‡æœŸ
    
    INDEX idx_user_created (user_id, created_at DESC)
);
```

---

## 5. API æ¥å£

### 5.1 ç”¨æˆ·ç«¯ API

#### è·å–æ¨¡æ¿åˆ—è¡¨
```http
GET /api/v1/category-templates
Query Parameters:
  - group: string (å¯é€‰) æŒ‰ç»„ç­›é€‰
  - classification: string (å¯é€‰) income/expense/transfer
  - featured: boolean (å¯é€‰) åªè·å–æ¨è
  - search: string (å¯é€‰) æœç´¢å…³é”®è¯
  - page: number (é»˜è®¤1)
  - limit: number (é»˜è®¤20)

Response:
{
  "data": [
    {
      "id": "uuid",
      "name": "é¤é¥®ç¾é£Ÿ",
      "name_en": "Food & Dining",
      "color": "#eb5429",
      "icon": "utensils",
      "classification": "expense",
      "group": "daily_expense",
      "is_featured": true,
      "tags": ["çƒ­é—¨", "å¿…å¤‡"]
    }
  ],
  "pagination": {
    "total": 100,
    "page": 1,
    "limit": 20
  }
}
```

#### å¯¼å…¥æ¨¡æ¿
```http
POST /api/v1/categories/import
Body:
{
  "template_ids": ["uuid1", "uuid2"],
  "ledger_id": "uuid",
  "options": {
    "skip_existing": true,
    "customize": [
      {
        "template_id": "uuid1",
        "custom_name": "å¤–å‡ºå°±é¤",
        "custom_color": "#ff0000"
      }
    ]
  }
}

Response:
{
  "imported": 5,
  "skipped": 2,
  "failed": 0,
  "categories": [...]
}
```

#### åˆ†ç±» CRUD
```http
# åˆ›å»ºåˆ†ç±»
POST /api/v1/categories
Body:
{
  "name": "è‡ªå®šä¹‰åˆ†ç±»",
  "classification": "expense",
  "color": "#6471eb",
  "icon": "tag",
  "parent_id": null,
  "ledger_id": "uuid"
}

# æ›´æ–°åˆ†ç±»
PUT /api/v1/categories/{id}
Body:
{
  "name": "æ–°åç§°",
  "color": "#4da568",
  "position": 2
}

# è·å–åˆ†ç±»åˆ—è¡¨
GET /api/v1/categories
Query: ?ledger_id={uuid}&include_subcategories=true

# åˆ é™¤åˆ†ç±»
DELETE /api/v1/categories/{id}
Body:
{
  "deletion_strategy": "move_to_category",
  "target_category_id": "uuid"
}
```

#### åˆ†ç±»è½¬æ¢
```http
# è½¬ä¸ºæ ‡ç­¾
POST /api/v1/categories/{id}/convert-to-tag
Body:
{
  "tag_name": "é¤é¥®",
  "apply_to_transactions": true,
  "delete_category": false,
  "transaction_date_range": {
    "from": "2024-01-01",
    "to": "2024-12-31"
  }
}

Response:
{
  "tag": {
    "id": "uuid",
    "name": "é¤é¥®",
    "color": "#eb5429"
  },
  "transactions_updated": 150,
  "category_status": "retained"
}
```

#### è·å–åˆ†ç±»äº¤æ˜“
```http
GET /api/v1/categories/{id}/transactions
Query Parameters:
  - date_from: string
  - date_to: string
  - sort_by: date|amount
  - sort_order: asc|desc
  - page: number
  - limit: number

Response:
{
  "transactions": [...],
  "summary": {
    "total_amount": 5000.00,
    "average_amount": 250.00,
    "transaction_count": 20,
    "date_range": {
      "from": "2024-01-01",
      "to": "2024-12-31"
    }
  },
  "pagination": {...}
}
```

#### æ‰¹é‡æ“ä½œ
```http
# æ‰¹é‡é‡åˆ†ç±»
POST /api/v1/transactions/batch-recategorize
Body:
{
  "transaction_ids": ["uuid1", "uuid2"],
  "target_category_id": "uuid",
  "add_tag": "åŸåˆ†ç±»å",
  "create_batch_record": true
}

# æ’¤é”€æ‰¹é‡æ“ä½œ
POST /api/v1/transactions/batch-undo/{batch_id}

# å±‚çº§è°ƒæ•´
PUT /api/v1/categories/{id}/hierarchy
Body:
{
  "parent_id": "uuid|null",
  "position": 2
}
```

### 5.2 ç®¡ç†ç«¯ API

#### æ¨¡æ¿ç®¡ç†
```http
# åˆ›å»ºæ¨¡æ¿
POST /api/v1/admin/category-templates
Headers: Authorization: Bearer {admin_token}
Body:
{
  "name": "æ–°æ¨¡æ¿",
  "name_en": "New Template",
  "classification": "expense",
  "color": "#6471eb",
  "icon": "tag",
  "group": "daily_expense",
  "is_featured": true,
  "tags": ["æ–°å¢"]
}

# æ‰¹é‡å¯¼å…¥æ¨¡æ¿
POST /api/v1/admin/category-templates/bulk-import
Headers: Authorization: Bearer {admin_token}
Body:
{
  "templates": [...],
  "update_existing": true,
  "skip_validation": false
}

# è·å–ä½¿ç”¨ç»Ÿè®¡
GET /api/v1/admin/category-templates/statistics
Response:
{
  "total_templates": 50,
  "active_templates": 45,
  "most_used": [
    {
      "template_id": "uuid",
      "name": "é¤é¥®ç¾é£Ÿ",
      "usage_count": 1250
    }
  ]
}
```

---

## 6. ç”¨æˆ·ç•Œé¢

### 6.1 ç”¨æˆ·ç«¯ç•Œé¢ç»“æ„

#### åˆ†ç±»ç®¡ç†ä¸»é¡µ
```dart
CategoryManagementPage
â”œâ”€â”€ AppBar
â”‚   â”œâ”€â”€ æ ‡é¢˜: "åˆ†ç±»ç®¡ç†"
â”‚   â””â”€â”€ æ“ä½œ: [æ–°å»ºåˆ†ç±»æŒ‰é’®]
â”œâ”€â”€ ç»Ÿè®¡é¢æ¿
â”‚   â”œâ”€â”€ æ€»åˆ†ç±»æ•°é‡
â”‚   â”œâ”€â”€ æ”¶å…¥åˆ†ç±»æ•°é‡
â”‚   â”œâ”€â”€ æ”¯å‡ºåˆ†ç±»æ•°é‡
â”‚   â””â”€â”€ è½¬è´¦åˆ†ç±»æ•°é‡
â”œâ”€â”€ æœç´¢æ 
â”‚   â”œâ”€â”€ æœç´¢è¾“å…¥æ¡†
â”‚   â””â”€â”€ ç­›é€‰æŒ‰é’®
â”œâ”€â”€ Tab æ  (æ”¶å…¥/æ”¯å‡º/è½¬è´¦)
â”œâ”€â”€ åˆ†ç±»åˆ—è¡¨
â”‚   â”œâ”€â”€ çˆ¶åˆ†ç±»é¡¹
â”‚   â”‚   â”œâ”€â”€ åˆ†ç±»å›¾æ ‡å’Œé¢œè‰²
â”‚   â”‚   â”œâ”€â”€ åˆ†ç±»åç§°
â”‚   â”‚   â”œâ”€â”€ ä½¿ç”¨æ¬¡æ•°(å¯ç‚¹å‡»)
â”‚   â”‚   â”œâ”€â”€ æ‹–æ‹½æ‰‹æŸ„
â”‚   â”‚   â””â”€â”€ æ“ä½œèœå•
â”‚   â””â”€â”€ å­åˆ†ç±»é¡¹ (ç¼©è¿›æ˜¾ç¤º)
â””â”€â”€ æµ®åŠ¨æ“ä½œæŒ‰é’®
    â”œâ”€â”€ æ–°å»ºåˆ†ç±»
    â””â”€â”€ ä»æ¨¡æ¿å¯¼å…¥
```

#### æ¨¡æ¿åº“æµè§ˆé¡µé¢
```dart
CategoryLibraryPage
â”œâ”€â”€ AppBar
â”‚   â”œâ”€â”€ æ ‡é¢˜: "åˆ†ç±»æ¨¡æ¿åº“"
â”‚   â”œâ”€â”€ æ›´æ–°æ—¶é—´æ˜¾ç¤º
â”‚   â””â”€â”€ åˆ·æ–°æŒ‰é’®
â”œâ”€â”€ æ›´æ–°æç¤ºæ¡ (å¦‚æœ‰æ–°æ¨¡æ¿)
â”œâ”€â”€ åˆ†ç»„æ ‡ç­¾æ 
â”‚   â”œâ”€â”€ å…¨éƒ¨
â”‚   â”œâ”€â”€ æ”¶å…¥ç±»åˆ«
â”‚   â”œâ”€â”€ æ—¥å¸¸æ¶ˆè´¹
â”‚   â”œâ”€â”€ å±…ä½ç›¸å…³
â”‚   â””â”€â”€ ... (å…¶ä»–åˆ†ç»„)
â”œâ”€â”€ æ¨¡æ¿ç½‘æ ¼
â”‚   â”œâ”€â”€ æ¨¡æ¿å¡ç‰‡
â”‚   â”‚   â”œâ”€â”€ æ¨¡æ¿å›¾æ ‡å’Œé¢œè‰²
â”‚   â”‚   â”œâ”€â”€ æ¨¡æ¿åç§°
â”‚   â”‚   â”œâ”€â”€ æè¿°ä¿¡æ¯
â”‚   â”‚   â”œâ”€â”€ æ¨èæ ‡è¯†
â”‚   â”‚   â”œâ”€â”€ å·²å¯¼å…¥æ ‡è¯†
â”‚   â”‚   â””â”€â”€ å¯¼å…¥æŒ‰é’®
â”‚   â””â”€â”€ åŠ è½½æ›´å¤š
â””â”€â”€ ä¸‹æ‹‰åˆ·æ–°æ”¯æŒ
```

#### åˆ†ç±»è½¬æ¢å¯¹è¯æ¡†
```dart
CategoryToTagDialog
â”œâ”€â”€ æ ‡é¢˜: "è½¬æ¢ä¸ºæ ‡ç­¾"
â”œâ”€â”€ åˆ†ç±»ä¿¡æ¯å±•ç¤º
â”‚   â”œâ”€â”€ åˆ†ç±»å›¾æ ‡å’Œé¢œè‰²
â”‚   â”œâ”€â”€ åˆ†ç±»åç§°
â”‚   â””â”€â”€ ä½¿ç”¨æ¬¡æ•°
â”œâ”€â”€ è½¬æ¢é€‰é¡¹
â”‚   â”œâ”€â”€ æ ‡ç­¾åç§°è¾“å…¥æ¡†
â”‚   â”œâ”€â”€ "åº”ç”¨åˆ°å†å²äº¤æ˜“" é€‰æ‹©æ¡†
â”‚   â””â”€â”€ "åˆ é™¤åŸåˆ†ç±»" é€‰æ‹©æ¡†
â”œâ”€â”€ å½±å“èŒƒå›´é¢„è§ˆ
â”‚   â”œâ”€â”€ å—å½±å“äº¤æ˜“æ•°é‡
â”‚   â””â”€â”€ æ—¶é—´èŒƒå›´é€‰æ‹©
â””â”€â”€ æ“ä½œæŒ‰é’®
    â”œâ”€â”€ å–æ¶ˆæŒ‰é’®
    â””â”€â”€ ç¡®è®¤è½¬æ¢æŒ‰é’®
```

#### äº¤æ˜“æ˜ç»†é¡µé¢
```dart
CategoryTransactionsPage
â”œâ”€â”€ AppBar
â”‚   â”œâ”€â”€ æ ‡é¢˜: "åˆ†ç±»äº¤æ˜“æ˜ç»†"
â”‚   â””â”€â”€ ç­›é€‰å’Œæ’åºæŒ‰é’®
â”œâ”€â”€ ç»Ÿè®¡æ‘˜è¦
â”‚   â”œâ”€â”€ æ€»é‡‘é¢
â”‚   â”œâ”€â”€ å¹³å‡é‡‘é¢
â”‚   â”œâ”€â”€ äº¤æ˜“ç¬”æ•°
â”‚   â””â”€â”€ æ—¶é—´èŒƒå›´
â”œâ”€â”€ ç­›é€‰æ 
â”‚   â”œâ”€â”€ æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨
â”‚   â”œâ”€â”€ æ’åºæ–¹å¼é€‰æ‹©
â”‚   â””â”€â”€ æ‰¹é‡æ“ä½œæŒ‰é’®
â”œâ”€â”€ äº¤æ˜“åˆ—è¡¨
â”‚   â”œâ”€â”€ äº¤æ˜“é¡¹
â”‚   â”‚   â”œâ”€â”€ äº¤æ˜“æè¿°
â”‚   â”‚   â”œâ”€â”€ äº¤æ˜“é‡‘é¢
â”‚   â”‚   â”œâ”€â”€ äº¤æ˜“æ—¥æœŸ
â”‚   â”‚   â”œâ”€â”€ é€‰æ‹©æ¡† (æ‰¹é‡æ¨¡å¼)
â”‚   â”‚   â””â”€â”€ å¿«é€Ÿé‡åˆ†ç±»æŒ‰é’®
â”‚   â””â”€â”€ åˆ†é¡µåŠ è½½
â””â”€â”€ æ‰¹é‡æ“ä½œå·¥å…·æ  (é€‰ä¸­æ—¶æ˜¾ç¤º)
    â”œâ”€â”€ é‡æ–°åˆ†ç±»
    â”œâ”€â”€ æ·»åŠ æ ‡ç­¾
    â””â”€â”€ å–æ¶ˆé€‰æ‹©
```

### 6.2 ç®¡ç†ç«¯ç•Œé¢ç»“æ„

#### ç®¡ç†å‘˜æ§åˆ¶å°
```dart
AdminDashboard
â”œâ”€â”€ AppBar: "ç®¡ç†å‘˜æ§åˆ¶å°"
â”œâ”€â”€ åŠŸèƒ½å¡ç‰‡ç½‘æ ¼
â”‚   â”œâ”€â”€ åˆ†ç±»æ¨¡æ¿ç®¡ç†å¡ç‰‡
â”‚   â”œâ”€â”€ åˆ†ç±»ç»„ç®¡ç†å¡ç‰‡
â”‚   â”œâ”€â”€ ä½¿ç”¨ç»Ÿè®¡å¡ç‰‡
â”‚   â””â”€â”€ ç³»ç»Ÿè®¾ç½®å¡ç‰‡
â””â”€â”€ å¿«æ·æ“ä½œåŒº
    â”œâ”€â”€ æ‰¹é‡å¯¼å…¥æŒ‰é’®
    â””â”€â”€ æ•°æ®å¯¼å‡ºæŒ‰é’®
```

#### æ¨¡æ¿ç®¡ç†é¡µé¢
```dart
CategoryTemplateManagementPage
â”œâ”€â”€ AppBar
â”‚   â”œâ”€â”€ æ ‡é¢˜: "ç³»ç»Ÿåˆ†ç±»æ¨¡æ¿ç®¡ç†"
â”‚   â””â”€â”€ æ“ä½œæŒ‰é’® [æ–°å»º, å¯¼å…¥, èœå•]
â”œâ”€â”€ ç­›é€‰å’Œæœç´¢æ 
â”‚   â”œâ”€â”€ æœç´¢è¾“å…¥æ¡†
â”‚   â”œâ”€â”€ åˆ†ç»„ç­›é€‰å™¨
â”‚   â”œâ”€â”€ çŠ¶æ€ç­›é€‰å™¨
â”‚   â””â”€â”€ é«˜çº§ç­›é€‰æŒ‰é’®
â”œâ”€â”€ ç»Ÿè®¡ä¿¡æ¯æ 
â”‚   â”œâ”€â”€ æ€»æ¨¡æ¿æ•°
â”‚   â”œâ”€â”€ æ´»è·ƒæ¨¡æ¿æ•°
â”‚   â”œâ”€â”€ æ¨èæ¨¡æ¿æ•°
â”‚   â””â”€â”€ ä½¿ç”¨ç»Ÿè®¡é“¾æ¥
â”œâ”€â”€ Tab æ  (æ”¶å…¥/æ”¯å‡º/è½¬è´¦)
â”œâ”€â”€ æ¨¡æ¿åˆ—è¡¨
â”‚   â”œâ”€â”€ åˆ—è¡¨å¤´ (å¯æ’åº)
â”‚   â”‚   â”œâ”€â”€ åç§°
â”‚   â”‚   â”œâ”€â”€ åˆ†ç»„
â”‚   â”‚   â”œâ”€â”€ ä½¿ç”¨æ¬¡æ•°
â”‚   â”‚   â”œâ”€â”€ çŠ¶æ€
â”‚   â”‚   â””â”€â”€ æ“ä½œ
â”‚   â””â”€â”€ æ¨¡æ¿è¡Œ
â”‚       â”œâ”€â”€ æ¨¡æ¿å›¾æ ‡å’Œé¢œè‰²
â”‚       â”œâ”€â”€ æ¨¡æ¿åç§°å’Œæè¿°
â”‚       â”œâ”€â”€ åˆ†ç»„ä¿¡æ¯
â”‚       â”œâ”€â”€ ä½¿ç”¨ç»Ÿè®¡
â”‚       â”œâ”€â”€ æ¨èæ ‡è¯†
â”‚       â”œâ”€â”€ æ´»è·ƒçŠ¶æ€å¼€å…³
â”‚       â””â”€â”€ æ“ä½œèœå• [ç¼–è¾‘, å¤åˆ¶, åˆ é™¤]
â””â”€â”€ åˆ†é¡µæ§ä»¶
```

#### æ¨¡æ¿ç¼–è¾‘å¯¹è¯æ¡†
```dart
CategoryTemplateEditDialog
â”œâ”€â”€ æ ‡é¢˜: "åˆ›å»º/ç¼–è¾‘åˆ†ç±»æ¨¡æ¿"
â”œâ”€â”€ è¡¨å•å­—æ®µ
â”‚   â”œâ”€â”€ åŸºç¡€ä¿¡æ¯ç»„
â”‚   â”‚   â”œâ”€â”€ æ¨¡æ¿åç§° (å¿…å¡«)
â”‚   â”‚   â”œâ”€â”€ è‹±æ–‡åç§°
â”‚   â”‚   â”œâ”€â”€ ä¸­æ–‡åç§°
â”‚   â”‚   â””â”€â”€ æè¿°
â”‚   â”œâ”€â”€ åˆ†ç±»å±æ€§ç»„
â”‚   â”‚   â”œâ”€â”€ åˆ†ç±»ç±»å‹é€‰æ‹© (å¿…å¡«)
â”‚   â”‚   â””â”€â”€ æ‰€å±åˆ†ç»„é€‰æ‹© (å¿…å¡«)
â”‚   â”œâ”€â”€ è§†è§‰è®¾ç½®ç»„
â”‚   â”‚   â”œâ”€â”€ é¢œè‰²é€‰æ‹©å™¨
â”‚   â”‚   â””â”€â”€ å›¾æ ‡é€‰æ‹©å™¨
â”‚   â”œâ”€â”€ å…ƒæ•°æ®ç»„
â”‚   â”‚   â”œâ”€â”€ æ ‡ç­¾è¾“å…¥ (å¯å¤šä¸ª)
â”‚   â”‚   â””â”€â”€ è®¾ä¸ºæ¨èé€‰æ‹©æ¡†
â”‚   â””â”€â”€ é¢„è§ˆåŒºåŸŸ
â”‚       â””â”€â”€ å®æ—¶é¢„è§ˆæ•ˆæœ
â””â”€â”€ æ“ä½œæŒ‰é’®
    â”œâ”€â”€ å–æ¶ˆ
    â”œâ”€â”€ ä¿å­˜è‰ç¨¿
    â””â”€â”€ å‘å¸ƒ
```

### 6.3 äº¤äº’è®¾è®¡è¦ç‚¹

#### æ‹–æ‹½æ’åº
- **è§†è§‰åé¦ˆ**ï¼šæ‹–æ‹½æ—¶é«˜äº®ç›®æ ‡åŒºåŸŸ
- **çº¦æŸæç¤º**ï¼šä¸ç¬¦åˆè§„åˆ™æ—¶æ˜¾ç¤ºç¦æ­¢å›¾æ ‡
- **å®æ—¶ä¿å­˜**ï¼šæ‹–æ‹½å®Œæˆåç«‹å³ä¿å­˜ä½ç½®

#### æ‰¹é‡æ“ä½œ
- **å¤šé€‰æ¨¡å¼**ï¼šé•¿æŒ‰è¿›å…¥å¤šé€‰æ¨¡å¼
- **æ“ä½œå·¥å…·æ **ï¼šåº•éƒ¨æ˜¾ç¤ºæ‰¹é‡æ“ä½œé€‰é¡¹
- **è¿›åº¦æ˜¾ç¤º**ï¼šæ‰¹é‡æ“ä½œæ—¶æ˜¾ç¤ºè¿›åº¦æ¡

#### æ™ºèƒ½æç¤º
- **å†²çªæ£€æµ‹**ï¼šåŒååˆ†ç±»å®æ—¶æç¤º
- **ä½¿ç”¨å»ºè®®**ï¼šåŸºäºå†å²æ¨èåˆ†ç±»
- **æ“ä½œå¼•å¯¼**ï¼šæ–°ç”¨æˆ·æ“ä½œå¼•å¯¼

---

## 7. ä¸šåŠ¡æµç¨‹

### 7.1 æ¨¡æ¿å¯¼å…¥æµç¨‹
```mermaid
graph TB
    A[ç”¨æˆ·æ‰“å¼€åˆ†ç±»åº“] --> B[æµè§ˆæ¨¡æ¿]
    B --> C[é€‰æ‹©æ¨¡æ¿]
    C --> D{æ£€æŸ¥é‡å¤}
    D -->|å­˜åœ¨é‡å¤| E[æ˜¾ç¤ºå†²çªå¤„ç†é€‰é¡¹]
    D -->|æ— é‡å¤| F[æ˜¾ç¤ºè‡ªå®šä¹‰é€‰é¡¹]
    E --> G[ç”¨æˆ·é€‰æ‹©å¤„ç†æ–¹å¼]
    G --> H{å¤„ç†æ–¹å¼}
    H -->|è·³è¿‡| I[è·³è¿‡è¯¥æ¨¡æ¿]
    H -->|é‡å‘½å| J[è‡ªåŠ¨é‡å‘½å]
    H -->|è¦†ç›–| K[è¦†ç›–ç°æœ‰åˆ†ç±»]
    F --> L[ç”¨æˆ·è‡ªå®šä¹‰åç§°/é¢œè‰²]
    I --> M[å¤„ç†ä¸‹ä¸€ä¸ªæ¨¡æ¿]
    J --> M
    K --> M
    L --> N[ç¡®è®¤å¯¼å…¥]
    N --> O[åˆ›å»ºç”¨æˆ·åˆ†ç±»]
    O --> P[æ›´æ–°ä½¿ç”¨ç»Ÿè®¡]
    P --> Q[å¯¼å…¥å®Œæˆ]
    M --> R{è¿˜æœ‰æ¨¡æ¿?}
    R -->|æ˜¯| C
    R -->|å¦| Q
```

### 7.2 åˆ†ç±»è½¬æ ‡ç­¾æµç¨‹
```mermaid
graph TB
    A[ç”¨æˆ·é€‰æ‹©åˆ†ç±»] --> B[ç‚¹å‡»è½¬æ¢ä¸ºæ ‡ç­¾]
    B --> C[æ‰“å¼€è½¬æ¢å¯¹è¯æ¡†]
    C --> D[è®¾ç½®è½¬æ¢é€‰é¡¹]
    D --> E{åˆ†ç±»æœ‰äº¤æ˜“?}
    E -->|å¦| F[ç›´æ¥è½¬æ¢]
    E -->|æ˜¯| G[æ˜¾ç¤ºå½±å“èŒƒå›´]
    G --> H[ç”¨æˆ·é€‰æ‹©åº”ç”¨èŒƒå›´]
    H --> I[ç¡®è®¤è½¬æ¢]
    I --> J[åˆ›å»ºæ ‡ç­¾è®°å½•]
    J --> K{åº”ç”¨åˆ°äº¤æ˜“?}
    K -->|æ˜¯| L[æ‰¹é‡æ›´æ–°äº¤æ˜“æ ‡ç­¾]
    K -->|å¦| M[è·³è¿‡äº¤æ˜“æ›´æ–°]
    L --> N[åˆ›å»ºæ‰¹é‡æ“ä½œè®°å½•]
    M --> O{åˆ é™¤åŸåˆ†ç±»?}
    N --> O
    O -->|æ˜¯| P[æ ‡è®°åˆ†ç±»åˆ é™¤]
    O -->|å¦| Q[ä¿ç•™åˆ†ç±»]
    F --> R[è½¬æ¢å®Œæˆ]
    P --> R
    Q --> R
    R --> S[æ˜¾ç¤ºè½¬æ¢ç»“æœ]
```

### 7.3 åˆ†ç±»åˆ é™¤éªŒè¯æµç¨‹
```mermaid
graph TB
    A[ç”¨æˆ·åˆ é™¤åˆ†ç±»] --> B{åˆ†ç±»æœ‰äº¤æ˜“?}
    B -->|å¦| C[ç›´æ¥åˆ é™¤]
    B -->|æ˜¯| D[æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†]
    D --> E[æ˜¾ç¤ºå¤„ç†é€‰é¡¹]
    E --> F{ç”¨æˆ·é€‰æ‹©}
    F -->|ç§»åŠ¨åˆ°å…¶ä»–åˆ†ç±»| G[æ˜¾ç¤ºåˆ†ç±»é€‰æ‹©å™¨]
    F -->|è½¬æ¢ä¸ºæ ‡ç­¾| H[æ‰§è¡Œè½¬æ¢æµç¨‹]
    F -->|è®¾ä¸ºæœªåˆ†ç±»| I[æ¸…é™¤äº¤æ˜“åˆ†ç±»]
    F -->|å–æ¶ˆ| J[å–æ¶ˆåˆ é™¤]
    G --> K[é€‰æ‹©ç›®æ ‡åˆ†ç±»]
    K --> L[æ‰¹é‡æ›´æ–°äº¤æ˜“åˆ†ç±»]
    H --> M[åˆ›å»ºåŒåæ ‡ç­¾]
    M --> N[åº”ç”¨æ ‡ç­¾åˆ°äº¤æ˜“]
    I --> O[æ¸…é™¤åˆ†ç±»å¼•ç”¨]
    L --> P[åˆ›å»ºæ‰¹é‡æ“ä½œè®°å½•]
    N --> P
    O --> P
    P --> Q[åˆ é™¤åˆ†ç±»]
    Q --> R[åˆ é™¤å®Œæˆ]
    C --> R
    J --> S[æ“ä½œå–æ¶ˆ]
```

### 7.4 æ‰¹é‡é‡åˆ†ç±»æµç¨‹
```mermaid
graph TB
    A[è¿›å…¥åˆ†ç±»äº¤æ˜“é¡µé¢] --> B[å¯ç”¨å¤šé€‰æ¨¡å¼]
    B --> C[é€‰æ‹©ç›®æ ‡äº¤æ˜“]
    C --> D[ç‚¹å‡»æ‰¹é‡é‡åˆ†ç±»]
    D --> E[æ˜¾ç¤ºç›®æ ‡åˆ†ç±»é€‰æ‹©å™¨]
    E --> F[é€‰æ‹©æ–°åˆ†ç±»]
    F --> G{æ·»åŠ æ ‡ç­¾é€‰é¡¹?}
    G -->|æ˜¯| H[è¾“å…¥æ ‡ç­¾åç§°]
    G -->|å¦| I[ç¡®è®¤æ‰¹é‡æ›´æ”¹]
    H --> I
    I --> J[åˆ›å»ºæ‰¹é‡æ“ä½œè®°å½•]
    J --> K[å¼€å§‹æ‰¹é‡æ›´æ–°]
    K --> L[æ›´æ–°äº¤æ˜“åˆ†ç±»]
    L --> M{æ·»åŠ æ ‡ç­¾?}
    M -->|æ˜¯| N[ä¸ºäº¤æ˜“æ·»åŠ æ ‡ç­¾]
    M -->|å¦| O[æ›´æ–°åˆ†ç±»ä½¿ç”¨ç»Ÿè®¡]
    N --> O
    O --> P[æ“ä½œå®Œæˆ]
    P --> Q[æ˜¾ç¤ºæ“ä½œç»“æœ]
    Q --> R[æä¾›æ’¤é”€é€‰é¡¹]
```

---

## 8. æŠ€æœ¯å®ç°

### 8.1 ç¼“å­˜ç­–ç•¥

#### å¤šçº§ç¼“å­˜æ¶æ„
```dart
class CategoryCacheManager {
  // ç¼“å­˜å±‚çº§
  static const Duration MEMORY_TTL = Duration(minutes: 5);   // L1: å†…å­˜
  static const Duration LOCAL_TTL = Duration(hours: 24);     // L2: æœ¬åœ°å­˜å‚¨
  static const Duration STALE_TTL = Duration(days: 7);       // L3: è¿‡æœŸç¼“å­˜
  
  // ç¼“å­˜é”®å®šä¹‰
  static const String TEMPLATES_KEY = 'system_templates';
  static const String USER_CATEGORIES_KEY = 'user_categories';
  static const String GROUPS_KEY = 'category_groups';
  
  final MemoryCache _memoryCache = MemoryCache();
  final LocalStorage _localStorage = LocalStorage('category_cache');
  
  /// æ™ºèƒ½ç¼“å­˜è·å–
  Future<T?> get<T>(String key, T Function(Map<String, dynamic>) fromJson) async {
    // L1: å†…å­˜ç¼“å­˜
    final memoryData = _memoryCache.get(key);
    if (memoryData != null) {
      return memoryData as T;
    }
    
    // L2: æœ¬åœ°å­˜å‚¨
    final localData = await _localStorage.get(key);
    if (localData != null && _isLocalCacheValid(key)) {
      final result = fromJson(localData);
      _memoryCache.set(key, result, MEMORY_TTL);
      return result;
    }
    
    return null;
  }
  
  /// æ›´æ–°æ‰€æœ‰ç¼“å­˜å±‚
  Future<void> set<T>(String key, T data) async {
    _memoryCache.set(key, data, MEMORY_TTL);
    await _localStorage.set(key, data);
    await _setMetadata(key, DateTime.now());
  }
  
  /// ç¼“å­˜å¤±æ•ˆç­–ç•¥
  bool _isLocalCacheValid(String key) {
    final metadata = _getMetadata(key);
    if (metadata == null) return false;
    
    final age = DateTime.now().difference(metadata);
    return age < LOCAL_TTL;
  }
}
```

#### ETag æ”¯æŒ
```dart
class ETagManager {
  final Map<String, String> _etags = {};
  
  /// æ·»åŠ  ETag åˆ°è¯·æ±‚å¤´
  Map<String, String> getHeaders(String endpoint) {
    final headers = <String, String>{};
    final etag = _etags[endpoint];
    
    if (etag != null) {
      headers['If-None-Match'] = etag;
    }
    
    return headers;
  }
  
  /// å¤„ç†å“åº”ä¸­çš„ ETag
  bool handleResponse(String endpoint, http.Response response) {
    final etag = response.headers['etag'];
    if (etag != null) {
      _etags[endpoint] = etag;
    }
    
    // è¿”å›æ˜¯å¦æœ‰æ›´æ–°
    return response.statusCode != 304;
  }
}
```

### 8.2 æ‹–æ‹½æ’åºå®ç°

```dart
class DraggableCategoryList extends StatefulWidget {
  final List<Category> categories;
  final Function(int oldIndex, int newIndex) onReorder;
  
  @override
  Widget build(BuildContext context) {
    return ReorderableListView.builder(
      itemCount: categories.length,
      onReorder: _handleReorder,
      itemBuilder: (context, index) {
        final category = categories[index];
        return DragTarget<Category>(
          key: ValueKey(category.id),
          onAccept: (draggedCategory) {
            _handleDrop(draggedCategory, category);
          },
          onWillAccept: (draggedCategory) {
            return _canAcceptDrop(draggedCategory, category);
          },
          builder: (context, candidateData, rejectedData) {
            return LongPressDraggable<Category>(
              data: category,
              feedback: CategoryDragFeedback(category: category),
              childWhenDragging: CategoryPlaceholder(category: category),
              child: CategoryListItem(
                category: category,
                isDropTarget: candidateData.isNotEmpty,
                canAcceptDrop: _canAcceptDrop(candidateData.firstOrNull, category),
              ),
            );
          },
        );
      },
    );
  }
  
  bool _canAcceptDrop(Category? dragged, Category target) {
    if (dragged == null) return false;
    
    // ä¸èƒ½æ‹–åˆ°è‡ªå·±
    if (dragged.id == target.id) return false;
    
    // ä¸èƒ½æ‹–åˆ°è‡ªå·±çš„å­åˆ†ç±»
    if (_isDescendant(target, dragged)) return false;
    
    // åˆ†ç±»ç±»å‹å¿…é¡»ä¸€è‡´
    if (dragged.classification != target.classification) return false;
    
    // å±‚çº§é™åˆ¶ï¼šæœ€å¤šä¸¤å±‚
    if (target.isChild && dragged.hasChildren) return false;
    
    return true;
  }
  
  void _handleReorder(int oldIndex, int newIndex) {
    // é˜²æŠ–å¤„ç†
    _debouncer.run(() {
      widget.onReorder(oldIndex, newIndex);
    });
  }
}
```

### 8.3 æ‰¹é‡æ“ä½œå®ç°

```dart
class BatchOperationManager {
  final List<BatchOperation> _operationQueue = [];
  final Map<String, Timer> _autoCommitTimers = {};
  
  /// æ·»åŠ æ‰¹é‡æ“ä½œåˆ°é˜Ÿåˆ—
  Future<String> addOperation(BatchOperationRequest request) async {
    final operation = BatchOperation(
      id: _generateId(),
      type: request.type,
      userId: request.userId,
      originalData: request.originalData,
      targetData: request.targetData,
      status: BatchOperationStatus.pending,
      createdAt: DateTime.now(),
    );
    
    _operationQueue.add(operation);
    
    // è®¾ç½®è‡ªåŠ¨æäº¤å®šæ—¶å™¨
    _setAutoCommitTimer(operation.id);
    
    return operation.id;
  }
  
  /// æ‰§è¡Œæ‰¹é‡æ“ä½œ
  Future<BatchOperationResult> executeOperation(String operationId) async {
    final operation = _operationQueue.firstWhere((op) => op.id == operationId);
    
    operation.status = BatchOperationStatus.executing;
    
    try {
      switch (operation.type) {
        case BatchOperationType.recategorize:
          return await _executeBatchRecategorize(operation);
        case BatchOperationType.convertToTag:
          return await _executeBatchConversion(operation);
        case BatchOperationType.merge:
          return await _executeBatchMerge(operation);
      }
    } catch (e) {
      operation.status = BatchOperationStatus.failed;
      operation.error = e.toString();
      rethrow;
    }
  }
  
  /// æ’¤é”€æ‰¹é‡æ“ä½œ
  Future<void> revertOperation(String operationId) async {
    final operation = _operationQueue.firstWhere((op) => op.id == operationId);
    
    if (!operation.canRevert) {
      throw Exception('Operation cannot be reverted');
    }
    
    if (operation.isExpired) {
      throw Exception('Operation has expired');
    }
    
    // æ ¹æ®æ“ä½œç±»å‹æ‰§è¡Œæ’¤é”€
    await _revertByType(operation);
    
    operation.status = BatchOperationStatus.reverted;
    operation.revertedAt = DateTime.now();
  }
  
  void _setAutoCommitTimer(String operationId) {
    _autoCommitTimers[operationId] = Timer(Duration(hours: 24), () {
      _expireOperation(operationId);
    });
  }
}
```

### 8.4 å®æ—¶åŒæ­¥æœºåˆ¶

```dart
class CategorySyncManager {
  final StreamController<CategorySyncEvent> _eventController = 
      StreamController<CategorySyncEvent>.broadcast();
  
  Stream<CategorySyncEvent> get events => _eventController.stream;
  
  /// åŒæ­¥æœ¬åœ°æ›´æ”¹åˆ°æœåŠ¡å™¨
  Future<void> syncToServer(List<CategoryChange> changes) async {
    final syncBatch = SyncBatch(
      changes: changes,
      timestamp: DateTime.now(),
      deviceId: await _getDeviceId(),
    );
    
    try {
      final response = await _api.syncCategories(syncBatch);
      
      // å¤„ç†å†²çª
      if (response.hasConflicts) {
        await _resolveConflicts(response.conflicts);
      }
      
      // æ›´æ–°æœ¬åœ°çŠ¶æ€
      await _updateLocalState(response.appliedChanges);
      
      _eventController.add(CategorySyncEvent.success(response));
    } catch (e) {
      _eventController.add(CategorySyncEvent.error(e));
    }
  }
  
  /// å†²çªè§£å†³ç­–ç•¥
  Future<void> _resolveConflicts(List<SyncConflict> conflicts) async {
    for (final conflict in conflicts) {
      switch (conflict.type) {
        case ConflictType.nameCollision:
          // è‡ªåŠ¨é‡å‘½å
          await _autoResolveNameCollision(conflict);
          break;
        case ConflictType.deletedOnServer:
          // è¯¢é—®ç”¨æˆ·æ˜¯å¦æ¢å¤
          await _askUserToRestore(conflict);
          break;
        case ConflictType.modifiedOnBothSides:
          // æ˜¾ç¤ºå†²çªè§£å†³ç•Œé¢
          await _showConflictResolutionUI(conflict);
          break;
      }
    }
  }
}
```

### 8.5 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### å»¶è¿ŸåŠ è½½
```dart
class LazyLoadingManager {
  final Map<String, Completer<List<Category>>> _loadingCache = {};
  
  /// åˆ†é¡µåŠ è½½åˆ†ç±»
  Future<List<Category>> loadCategories({
    required int page,
    required int pageSize,
    String? parentId,
  }) async {
    final cacheKey = 'categories_${parentId ?? 'root'}_${page}';
    
    // é˜²æ­¢é‡å¤è¯·æ±‚
    if (_loadingCache.containsKey(cacheKey)) {
      return _loadingCache[cacheKey]!.future;
    }
    
    final completer = Completer<List<Category>>();
    _loadingCache[cacheKey] = completer;
    
    try {
      final categories = await _fetchCategoriesPage(page, pageSize, parentId);
      
      // é¢„åŠ è½½ä¸‹ä¸€é¡µ
      if (categories.length == pageSize) {
        _preloadNextPage(page + 1, pageSize, parentId);
      }
      
      completer.complete(categories);
      return categories;
    } catch (e) {
      completer.completeError(e);
      rethrow;
    } finally {
      _loadingCache.remove(cacheKey);
    }
  }
  
  void _preloadNextPage(int nextPage, int pageSize, String? parentId) {
    // åœ¨åå°é¢„åŠ è½½ï¼Œä¸é˜»å¡å½“å‰æ“ä½œ
    Future.microtask(() {
      loadCategories(page: nextPage, pageSize: pageSize, parentId: parentId);
    });
  }
}
```

#### é˜²æŠ–ä¼˜åŒ–
```dart
class Debouncer {
  final Duration delay;
  Timer? _timer;
  
  Debouncer({this.delay = const Duration(milliseconds: 500)});
  
  void run(VoidCallback action) {
    _timer?.cancel();
    _timer = Timer(delay, action);
  }
  
  void dispose() {
    _timer?.cancel();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
class SearchController {
  final Debouncer _searchDebouncer = Debouncer();
  
  void onSearchChanged(String query) {
    _searchDebouncer.run(() {
      _performSearch(query);
    });
  }
}
```

---

## 9. éƒ¨ç½²æ–¹æ¡ˆ

### 9.1 ç¯å¢ƒè¦æ±‚

#### å¼€å‘ç¯å¢ƒ
- **Flutter**: 3.16.0+
- **Dart**: 3.2.0+
- **Rust**: 1.75.0+
- **PostgreSQL**: 15.0+
- **Redis**: 7.0+ (å¯é€‰ï¼Œç”¨äºç¼“å­˜)

#### ç”Ÿäº§ç¯å¢ƒ
- **CPU**: 2 æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**: 4GB ä»¥ä¸Š
- **å­˜å‚¨**: 100GB SSD
- **ç½‘ç»œ**: 10Mbps ä»¥ä¸Š

### 9.2 æ•°æ®åº“åˆå§‹åŒ–

#### åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE jive_money_prod;

-- åˆ›å»ºç”¨æˆ·
CREATE USER jive_api WITH PASSWORD 'secure_password';

-- æˆæƒ
GRANT ALL PRIVILEGES ON DATABASE jive_money_prod TO jive_api;
GRANT USAGE ON SCHEMA public TO jive_api;
GRANT CREATE ON SCHEMA public TO jive_api;
```

#### æ‰§è¡Œè¿ç§»è„šæœ¬
```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
cd jive-api
sqlx migrate run --database-url="postgresql://jive_api:password@localhost/jive_money_prod"

# æˆ–ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬
psql -U jive_api -d jive_money_prod -f migrations/001_initial_schema.sql
psql -U jive_api -d jive_money_prod -f migrations/002_seed_data.sql
```

#### ç§å­æ•°æ®
```sql
-- æ’å…¥é»˜è®¤åˆ†ç±»ç»„
INSERT INTO category_groups (id, key, name, name_en, name_zh, display_order) VALUES
('550e8400-e29b-41d4-a716-446655440001', 'income', 'æ”¶å…¥ç±»åˆ«', 'Income', 'æ”¶å…¥ç±»åˆ«', 1),
('550e8400-e29b-41d4-a716-446655440002', 'daily_expense', 'æ—¥å¸¸æ¶ˆè´¹', 'Daily Expenses', 'æ—¥å¸¸æ¶ˆè´¹', 2),
('550e8400-e29b-41d4-a716-446655440003', 'housing', 'å±…ä½ç›¸å…³', 'Housing', 'å±…ä½ç›¸å…³', 3),
('550e8400-e29b-41d4-a716-446655440004', 'health_education', 'å¥åº·æ•™è‚²', 'Health & Education', 'å¥åº·æ•™è‚²', 4),
('550e8400-e29b-41d4-a716-446655440005', 'entertainment_social', 'å¨±ä¹ç¤¾äº¤', 'Entertainment & Social', 'å¨±ä¹ç¤¾äº¤', 5),
('550e8400-e29b-41d4-a716-446655440006', 'financial', 'é‡‘èç†è´¢', 'Financial', 'é‡‘èç†è´¢', 6),
('550e8400-e29b-41d4-a716-446655440007', 'business', 'å•†åŠ¡åŠå…¬', 'Business', 'å•†åŠ¡åŠå…¬', 7);

-- æ’å…¥ç³»ç»Ÿåˆ†ç±»æ¨¡æ¿ (ç¤ºä¾‹)
INSERT INTO system_category_templates (id, name, name_en, name_zh, classification, color, icon, category_group, is_featured) VALUES
('660e8400-e29b-41d4-a716-446655440001', 'å·¥èµ„æ”¶å…¥', 'Salary', 'å·¥èµ„æ”¶å…¥', 'income', '#10B981', 'circle-dollar-sign', 'income', true),
('660e8400-e29b-41d4-a716-446655440002', 'é¤é¥®ç¾é£Ÿ', 'Food & Dining', 'é¤é¥®ç¾é£Ÿ', 'expense', '#EF4444', 'utensils', 'daily_expense', true),
('660e8400-e29b-41d4-a716-446655440003', 'äº¤é€šå‡ºè¡Œ', 'Transportation', 'äº¤é€šå‡ºè¡Œ', 'expense', '#F97316', 'car', 'daily_expense', true);
```

### 9.3 åç«¯éƒ¨ç½²

#### Docker åŒ–éƒ¨ç½²
```dockerfile
# Dockerfile
FROM rust:1.75-slim as builder

WORKDIR /app
COPY . .

RUN apt-get update && apt-get install -y pkg-config libssl-dev
RUN cargo build --release

FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /app/target/release/jive-api .
COPY --from=builder /app/config ./config

EXPOSE 8080
CMD ["./jive-api"]
```

#### é…ç½®æ–‡ä»¶
```toml
# config/production.toml
[server]
host = "0.0.0.0"
port = 8080
workers = 4

[database]
url = "postgresql://jive_api:password@postgres:5432/jive_money_prod"
max_connections = 20
min_connections = 5
acquire_timeout = 30

[redis]
url = "redis://redis:6379"
pool_size = 10

[cors]
allowed_origins = ["https://app.jivemoney.com", "https://admin.jivemoney.com"]
allowed_methods = ["GET", "POST", "PUT", "DELETE", "PATCH"]
allowed_headers = ["Content-Type", "Authorization"]

[auth]
jwt_secret = "${JWT_SECRET}"
token_expiry = 86400  # 24 hours

[logging]
level = "info"
format = "json"

[cache]
enabled = true
default_ttl = 3600
```

#### Docker Compose
```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "8080:8080"
    environment:
      - RUST_ENV=production
      - JWT_SECRET=${JWT_SECRET}
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: jive_money_prod
      POSTGRES_USER: jive_api
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    restart: unless-stopped
    
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - /etc/letsencrypt:/etc/letsencrypt
    depends_on:
      - api
    restart: unless-stopped

volumes:
  postgres_data:
```

### 9.4 å‰ç«¯æ„å»º

#### Android æ„å»º
```bash
# ç”Ÿäº§æ„å»º
flutter build apk --release --target-platform android-arm64

# ç”Ÿæˆç­¾å APK
flutter build apk --release --target-platform android-arm64 \
  --key-store=key.jks \
  --key-store-password=$KEYSTORE_PASSWORD \
  --key-alias=jive-money \
  --key-password=$KEY_PASSWORD
```

#### iOS æ„å»º
```bash
# ç”Ÿäº§æ„å»º
flutter build ios --release

# Archive (éœ€è¦åœ¨ macOS ä¸Šæ‰§è¡Œ)
cd ios && xcodebuild -workspace Runner.xcworkspace \
  -scheme Runner -archivePath build/Runner.xcarchive archive

# å¯¼å‡º IPA
xcodebuild -exportArchive -archivePath build/Runner.xcarchive \
  -exportPath build/ios -exportOptionsPlist ExportOptions.plist
```

#### Web æ„å»º
```bash
# Web æ„å»º
flutter build web --release --web-renderer html

# ä¼˜åŒ–æ„å»º
flutter build web --release \
  --web-renderer html \
  --dart-define=FLUTTER_WEB_USE_SKIA=false \
  --source-maps
```

### 9.5 CI/CD é…ç½®

#### GitHub Actions
```yaml
name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.75.0
          
      - name: Run Flutter tests
        run: |
          cd jive-flutter
          flutter test
          
      - name: Run Rust tests
        run: |
          cd jive-api
          cargo test

  build-android:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        
      - name: Build APK
        run: |
          cd jive-flutter
          flutter build apk --release
          
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release.apk
          path: jive-flutter/build/app/outputs/flutter-apk/app-release.apk

  deploy-api:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Build and push Docker image
        env:
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
        run: |
          docker build -t $DOCKER_REGISTRY/jive-api:latest ./jive-api
          docker push $DOCKER_REGISTRY/jive-api:latest
          
      - name: Deploy to production
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/jive-money
            docker-compose pull api
            docker-compose up -d api
```

---

## 10. æµ‹è¯•è®¡åˆ’

### 10.1 æµ‹è¯•ç­–ç•¥

#### æµ‹è¯•é‡‘å­—å¡”
```
        /\
       /UI\      <- å°‘é‡ UI æµ‹è¯•ï¼ˆ10%ï¼‰
      /____\
     /      \
    / Widget \    <- ä¸­ç­‰ Widget æµ‹è¯•ï¼ˆ30%ï¼‰
   /__________\
  /            \
 /     Unit     \ <- å¤§é‡å•å…ƒæµ‹è¯•ï¼ˆ60%ï¼‰
/________________\
```

### 10.2 å•å…ƒæµ‹è¯•

#### Rust åç«¯æµ‹è¯•
```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[tokio::test]
    async fn test_create_category_template() {
        let service = CategoryTemplateService::new_for_test();
        
        let template = CreateTemplateRequest {
            name: "Test Template".to_string(),
            classification: Classification::Expense,
            color: "#FF0000".to_string(),
            icon: "test-icon".to_string(),
            group: "test_group".to_string(),
        };
        
        let result = service.create_template(template).await;
        
        assert!(result.is_ok());
        let created = result.unwrap();
        assert_eq!(created.name, "Test Template");
        assert_eq!(created.color, "#FF0000");
    }
    
    #[tokio::test]
    async fn test_import_template_with_conflict() {
        let service = CategoryService::new_for_test();
        
        // åˆ›å»ºç°æœ‰åˆ†ç±»
        let existing = service.create_category(CreateCategoryRequest {
            name: "Existing Category".to_string(),
            // ...
        }).await.unwrap();
        
        // å°è¯•å¯¼å…¥åŒåæ¨¡æ¿
        let import_request = ImportTemplateRequest {
            template_ids: vec!["template_id".to_string()],
            options: ImportOptions {
                skip_existing: true,
                // ...
            },
        };
        
        let result = service.import_templates(import_request).await;
        
        assert!(result.is_ok());
        let import_result = result.unwrap();
        assert_eq!(import_result.skipped, 1);
        assert_eq!(import_result.imported, 0);
    }
    
    #[tokio::test]
    async fn test_convert_category_to_tag() {
        let service = CategoryConversionService::new_for_test();
        
        // åˆ›å»ºåˆ†ç±»å’Œäº¤æ˜“
        let category = create_test_category().await;
        let transactions = create_test_transactions(&category.id, 5).await;
        
        let conversion_request = ConversionRequest {
            category_id: category.id,
            tag_name: Some("Test Tag".to_string()),
            apply_to_transactions: true,
            delete_category: true,
        };
        
        let result = service.convert_to_tag(conversion_request).await;
        
        assert!(result.is_ok());
        let conversion_result = result.unwrap();
        assert_eq!(conversion_result.transactions_updated, 5);
        assert_eq!(conversion_result.category_status, CategoryStatus::Deleted);
        
        // éªŒè¯æ ‡ç­¾æ˜¯å¦åˆ›å»º
        let tag = service.get_tag(conversion_result.tag.id).await;
        assert!(tag.is_ok());
        assert_eq!(tag.unwrap().name, "Test Tag");
    }
}
```

#### Flutter å‰ç«¯æµ‹è¯•
```dart
void main() {
  group('CategoryProvider Tests', () {
    late CategoryProvider provider;
    late MockCategoryService mockService;
    
    setUp(() {
      mockService = MockCategoryService();
      provider = CategoryProvider(mockService);
    });
    
    testWidgets('should load categories successfully', (tester) async {
      // Arrange
      final categories = [
        Category(id: '1', name: 'Test Category', classification: CategoryClassification.expense),
      ];
      when(mockService.getCategories(any)).thenAnswer((_) async => categories);
      
      // Act
      await provider.loadCategories('ledger_id');
      
      // Assert
      expect(provider.categories, equals(categories));
      expect(provider.isLoading, false);
      verify(mockService.getCategories('ledger_id')).called(1);
    });
    
    testWidgets('should handle import template', (tester) async {
      // Arrange
      final template = SystemCategoryTemplate(
        id: 'template_1',
        name: 'Template Category',
        classification: CategoryClassification.expense,
      );
      final importOptions = ImportOptions(skipExisting: true);
      
      when(mockService.importTemplate(any, any))
          .thenAnswer((_) async => ImportResult(imported: 1, skipped: 0));
      
      // Act
      final result = await provider.importTemplate(template, importOptions);
      
      // Assert
      expect(result.imported, 1);
      expect(result.skipped, 0);
      verify(mockService.importTemplate(template, importOptions)).called(1);
    });
    
    testWidgets('should convert category to tag', (tester) async {
      // Arrange
      final category = Category(id: '1', name: 'Test Category');
      final conversionOptions = ConversionOptions(
        tagName: 'Test Tag',
        applyToTransactions: true,
      );
      
      when(mockService.convertToTag(any, any))
          .thenAnswer((_) async => ConversionResult(
            tag: Tag(id: 'tag_1', name: 'Test Tag'),
            transactionsUpdated: 10,
          ));
      
      // Act
      final result = await provider.convertToTag(category, conversionOptions);
      
      // Assert
      expect(result.tag.name, 'Test Tag');
      expect(result.transactionsUpdated, 10);
    });
  });
  
  group('CategoryManagementPage Widget Tests', () {
    testWidgets('should display categories in list', (tester) async {
      // Arrange
      final categories = [
        Category(id: '1', name: 'Food', classification: CategoryClassification.expense),
        Category(id: '2', name: 'Transport', classification: CategoryClassification.expense),
      ];
      
      // Act
      await tester.pumpWidget(
        MaterialApp(
          home: CategoryManagementPage(),
        ),
      );
      
      // Mock provider data
      final provider = Provider.of<CategoryProvider>(tester.element(find.byType(CategoryManagementPage)), listen: false);
      provider.setCategories(categories);
      await tester.pump();
      
      // Assert
      expect(find.text('Food'), findsOneWidget);
      expect(find.text('Transport'), findsOneWidget);
    });
    
    testWidgets('should show import dialog when template library button tapped', (tester) async {
      // Arrange
      await tester.pumpWidget(MaterialApp(home: CategoryManagementPage()));
      
      // Act
      await tester.tap(find.byIcon(Icons.library_books));
      await tester.pumpAndSettle();
      
      // Assert
      expect(find.byType(CategoryLibraryPage), findsOneWidget);
    });
  });
}
```

### 10.3 é›†æˆæµ‹è¯•

#### API ç«¯åˆ°ç«¯æµ‹è¯•
```rust
#[cfg(test)]
mod integration_tests {
    use super::*;
    use rocket::local::blocking::Client;
    use rocket::http::{Status, ContentType};
    
    #[test]
    fn test_create_and_get_template() {
        let client = Client::tracked(rocket()).expect("valid rocket instance");
        
        // Create template
        let template_data = json!({
            "name": "Integration Test Template",
            "classification": "expense",
            "color": "#FF0000",
            "icon": "test-icon",
            "group": "test_group"
        });
        
        let response = client
            .post("/api/v1/admin/category-templates")
            .header(ContentType::JSON)
            .header(Header::new("Authorization", "Bearer admin_token"))
            .body(template_data.to_string())
            .dispatch();
        
        assert_eq!(response.status(), Status::Created);
        
        let created_template: SystemCategoryTemplate = response.into_json().expect("valid json");
        
        // Get template
        let get_response = client
            .get(format!("/api/v1/category-templates/{}", created_template.id))
            .dispatch();
        
        assert_eq!(get_response.status(), Status::Ok);
        
        let retrieved_template: SystemCategoryTemplate = get_response.into_json().expect("valid json");
        assert_eq!(retrieved_template.name, "Integration Test Template");
    }
    
    #[test]
    fn test_import_template_workflow() {
        let client = Client::tracked(rocket()).expect("valid rocket instance");
        
        // Create user and ledger first
        let user_token = create_test_user(&client);
        let ledger_id = create_test_ledger(&client, &user_token);
        
        // Create system template
        let template_id = create_test_template(&client).id;
        
        // Import template
        let import_data = json!({
            "template_ids": [template_id],
            "ledger_id": ledger_id,
            "options": {
                "skip_existing": false
            }
        });
        
        let response = client
            .post("/api/v1/categories/import")
            .header(ContentType::JSON)
            .header(Header::new("Authorization", format!("Bearer {}", user_token)))
            .body(import_data.to_string())
            .dispatch();
        
        assert_eq!(response.status(), Status::Ok);
        
        let import_result: ImportResult = response.into_json().expect("valid json");
        assert_eq!(import_result.imported, 1);
        assert_eq!(import_result.skipped, 0);
        
        // Verify category was created
        let categories_response = client
            .get(format!("/api/v1/categories?ledger_id={}", ledger_id))
            .header(Header::new("Authorization", format!("Bearer {}", user_token)))
            .dispatch();
        
        assert_eq!(categories_response.status(), Status::Ok);
        
        let categories: Vec<UserCategory> = categories_response.into_json().expect("valid json");
        assert_eq!(categories.len(), 1);
        assert_eq!(categories[0].source_type, Some("system".to_string()));
    }
}
```

#### Flutter é›†æˆæµ‹è¯•
```dart
void main() {
  group('Category Management Integration Tests', () {
    late IntegrationTestWidgetsFlutterBinding binding;
    
    setUpAll(() {
      binding = IntegrationTestWidgetsFlutterBinding.ensureInitialized();
    });
    
    testWidgets('complete category import workflow', (tester) async {
      // Launch app
      await tester.pumpWidget(JiveMoneyApp());
      await tester.pumpAndSettle();
      
      // Navigate to category management
      await tester.tap(find.byIcon(Icons.category));
      await tester.pumpAndSettle();
      
      // Open template library
      await tester.tap(find.text('ä»æ¨¡æ¿å¯¼å…¥'));
      await tester.pumpAndSettle();
      
      // Select a template
      await tester.tap(find.text('é¤é¥®ç¾é£Ÿ').first);
      await tester.pumpAndSettle();
      
      // Confirm import
      await tester.tap(find.text('å¯¼å…¥'));
      await tester.pumpAndSettle();
      
      // Verify category was imported
      expect(find.text('é¤é¥®ç¾é£Ÿ'), findsOneWidget);
      
      // Take screenshot
      await binding.takeScreenshot('category_imported');
    });
    
    testWidgets('category to tag conversion workflow', (tester) async {
      // Setup test data
      await setupTestCategories();
      
      await tester.pumpWidget(JiveMoneyApp());
      await tester.pumpAndSettle();
      
      // Navigate to category management
      await tester.tap(find.byIcon(Icons.category));
      await tester.pumpAndSettle();
      
      // Open category menu
      await tester.tap(find.byIcon(Icons.more_vert).first);
      await tester.pumpAndSettle();
      
      // Select convert to tag
      await tester.tap(find.text('è½¬æ¢ä¸ºæ ‡ç­¾'));
      await tester.pumpAndSettle();
      
      // Configure conversion options
      await tester.enterText(find.byType(TextField), 'ç¾é£Ÿæ ‡ç­¾');
      await tester.tap(find.byType(Checkbox));
      
      // Confirm conversion
      await tester.tap(find.text('ç¡®è®¤è½¬æ¢'));
      await tester.pumpAndSettle();
      
      // Verify conversion completed
      expect(find.text('è½¬æ¢æˆåŠŸ'), findsOneWidget);
      
      await binding.takeScreenshot('conversion_completed');
    });
  });
}
```

### 10.4 æ€§èƒ½æµ‹è¯•

#### è´Ÿè½½æµ‹è¯•è„šæœ¬
```bash
#!/bin/bash
# load_test.sh

# æµ‹è¯•æ¨¡æ¿åˆ—è¡¨ API
echo "Testing category templates API..."
wrk -t12 -c400 -d30s --timeout 10s \
    -H "Accept: application/json" \
    http://localhost:8080/api/v1/category-templates

# æµ‹è¯•ç”¨æˆ·åˆ†ç±» API
echo "Testing user categories API..."
wrk -t12 -c400 -d30s --timeout 10s \
    -H "Accept: application/json" \
    -H "Authorization: Bearer test_token" \
    http://localhost:8080/api/v1/categories?ledger_id=test_ledger

# æµ‹è¯•åˆ†ç±»å¯¼å…¥ API
echo "Testing category import API..."
wrk -t8 -c200 -d30s --timeout 10s \
    -s scripts/import_test.lua \
    http://localhost:8080/api/v1/categories/import
```

#### K6 æ€§èƒ½æµ‹è¯•
```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 }, // ä¸Šå‡åˆ°100ä¸ªç”¨æˆ·
    { duration: '5m', target: 100 }, // ä¿æŒ100ä¸ªç”¨æˆ·
    { duration: '2m', target: 200 }, // ä¸Šå‡åˆ°200ä¸ªç”¨æˆ·
    { duration: '5m', target: 200 }, // ä¿æŒ200ä¸ªç”¨æˆ·
    { duration: '2m', target: 0 },   // é™åˆ°0ä¸ªç”¨æˆ·
  ],
  thresholds: {
    http_req_duration: ['p(99)<1500'], // 99%çš„è¯·æ±‚åœ¨1.5ç§’å†…å®Œæˆ
    http_req_failed: ['rate<0.1'],     // é”™è¯¯ç‡å°äº10%
  },
};

const BASE_URL = 'http://localhost:8080/api/v1';

export default function () {
  let response;
  
  // æµ‹è¯•è·å–æ¨¡æ¿åˆ—è¡¨
  response = http.get(`${BASE_URL}/category-templates`);
  check(response, {
    'get templates status is 200': (r) => r.status === 200,
    'get templates response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
  
  // æµ‹è¯•è·å–ç”¨æˆ·åˆ†ç±»
  response = http.get(`${BASE_URL}/categories?ledger_id=test_ledger`, {
    headers: {
      'Authorization': 'Bearer test_token',
    },
  });
  check(response, {
    'get categories status is 200': (r) => r.status === 200,
    'get categories response time < 300ms': (r) => r.timings.duration < 300,
  });
  
  sleep(1);
}
```

### 10.5 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| æµ‹è¯•ç±»å‹ | è¦†ç›–ç‡ç›®æ ‡ | éªŒè¯å·¥å…· |
|---------|-----------|----------|
| å•å…ƒæµ‹è¯• | 90%+ | `cargo tarpaulin`, `flutter test --coverage` |
| é›†æˆæµ‹è¯• | 80%+ | è‡ªå®šä¹‰æµ‹è¯•æŠ¥å‘Š |
| API æµ‹è¯• | 95%+ | Postman/Newman |
| UI æµ‹è¯• | 70%+ | Flutter Integration Tests |

#### è¦†ç›–ç‡æ£€æŸ¥è„šæœ¬
```bash
#!/bin/bash
# coverage_check.sh

echo "Checking Rust test coverage..."
cd jive-api
cargo tarpaulin --out Html --output-dir coverage

echo "Checking Flutter test coverage..."
cd ../jive-flutter
flutter test --coverage
genhtml coverage/lcov.info -o coverage/html

echo "Coverage reports generated:"
echo "- Rust: jive-api/coverage/tarpaulin-report.html"
echo "- Flutter: jive-flutter/coverage/html/index.html"
```

---

## é™„å½•

### A. é»˜è®¤åˆ†ç±»æ¨¡æ¿æ•°æ®
```yaml
# å®Œæ•´çš„ 50+ é¢„è®¾æ¨¡æ¿
category_templates:
  income:
    - name: "å·¥èµ„æ”¶å…¥"
      name_en: "Salary"
      color: "#10B981"
      icon: "circle-dollar-sign"
      featured: true
    # ... å…¶ä»–æ”¶å…¥ç±»åˆ«
  
  daily_expense:
    - name: "é¤é¥®ç¾é£Ÿ"
      name_en: "Food & Dining"
      color: "#EF4444"
      icon: "utensils"
      featured: true
    # ... å…¶ä»–æ—¥å¸¸æ”¯å‡º
  
  # ... å…¶ä»–åˆ†ç»„
```

### B. API é”™è¯¯ç è§„èŒƒ
```yaml
error_codes:
  # 4xxx: å®¢æˆ·ç«¯é”™è¯¯
  4001: "åˆ†ç±»åç§°é‡å¤"
  4002: "åˆ†ç±»å±‚çº§è¶…é™ï¼ˆæœ€å¤šä¸¤å±‚ï¼‰"
  4003: "åˆ†ç±»æ­£åœ¨ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤"
  4004: "æ¨¡æ¿ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ"
  4005: "æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ“ä½œ"
  4006: "è´¦æœ¬ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®"
  4007: "åˆ†ç±»ç±»å‹ä¸åŒ¹é…"
  4008: "æ‰¹é‡æ“ä½œå·²è¿‡æœŸ"
  
  # 5xxx: æœåŠ¡å™¨é”™è¯¯
  5001: "æ•°æ®åº“è¿æ¥å¤±è´¥"
  5002: "ç¼“å­˜æœåŠ¡ä¸å¯ç”¨"
  5003: "æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
  5004: "å¤–éƒ¨æœåŠ¡è°ƒç”¨è¶…æ—¶"
  5005: "æ•°æ®åŒæ­¥å¤±è´¥"
```

### C. æ€§èƒ½åŸºå‡†
```yaml
performance_benchmarks:
  api_response_time:
    get_templates: "< 100ms (P95)"
    get_categories: "< 50ms (P95)"
    import_template: "< 200ms (P95)"
    convert_to_tag: "< 500ms (P95)"
  
  throughput:
    concurrent_users: 1000
    requests_per_second: 2000
    
  resource_usage:
    memory: "< 512MB (idle), < 1GB (peak)"
    cpu: "< 50% (normal load)"
    disk_io: "< 100 IOPS"
    
  mobile_app:
    cold_start: "< 3s"
    category_list_load: "< 1s"
    template_library_load: "< 2s"
    category_import: "< 5s (100 templates)"
```

### D. å®‰å…¨æ£€æŸ¥æ¸…å•
- [ ] SQL æ³¨å…¥é˜²æŠ¤
- [ ] XSS æ”»å‡»é˜²æŠ¤
- [ ] CSRF ä¿æŠ¤
- [ ] æƒé™éªŒè¯å®Œæ•´æ€§
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†
- [ ] API é™æµæœºåˆ¶
- [ ] è¾“å…¥æ•°æ®éªŒè¯
- [ ] æ—¥å¿—è„±æ•å¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: 3.0  
**æœ€åæ›´æ–°**: 2025-01-01  
**ç»´æŠ¤è€…**: Jive Money Team  
**çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½  
**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 1 å¼€å‘ï¼ˆæ•°æ®æ¨¡å‹å’ŒåŸºç¡€æ¶æ„ï¼‰