# Jive ç”¨æˆ·è§’è‰²æ¨¡å‹é€»è¾‘è®¾è®¡

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº† Jive ç³»ç»Ÿä¸­çš„ç”¨æˆ·è§’è‰²æ¨¡å‹ã€Family ç®¡ç†é€»è¾‘ã€æƒé™ä½“ç³»å’Œé‚€è¯·æœºåˆ¶ã€‚ç³»ç»Ÿé‡‡ç”¨å¤šç§Ÿæˆ·æ¶æ„ï¼Œæ¯ä¸ªç”¨æˆ·å¯ä»¥å±äºå¤šä¸ª Familyï¼Œåœ¨ä¸åŒ Family ä¸­æ‹¥æœ‰ä¸åŒçš„è§’è‰²å’Œæƒé™ã€‚

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **æ¯ä¸ªç”¨æˆ·éƒ½æœ‰ä¸ªäºº Family**
   - ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨åˆ›å»ºä¸ªäºº Family
   - ç”¨æˆ·æ˜¯ä¸ªäºº Family çš„ Owner
   - ä¸ªäºº Family ä¸å¯åˆ é™¤ï¼Œéšç”¨æˆ·è´¦å·ä¸€èµ·é”€æ¯

2. **ç”¨æˆ·å¯å±äºå¤šä¸ª Family**
   - ä¸€ä¸ªç”¨æˆ·å¯ä»¥åŠ å…¥å¤šä¸ª Family
   - åœ¨ä¸åŒ Family ä¸­å¯ä»¥æœ‰ä¸åŒè§’è‰²
   - å¯ä»¥åœ¨ Family ä¹‹é—´è‡ªç”±åˆ‡æ¢

3. **é‚€è¯·æœºåˆ¶æ™ºèƒ½åŒ–**
   - è‡ªåŠ¨è¯†åˆ«è¢«é‚€è¯·è€…æ˜¯å¦å·²æ³¨å†Œ
   - å·²æ³¨å†Œç”¨æˆ·ç›´æ¥åŠ å…¥ï¼Œæœªæ³¨å†Œç”¨æˆ·æ”¶åˆ°é‚€è¯·é“¾æ¥
   - æ”¯æŒé‚€è¯·ç å’Œé‚€è¯·é“¾æ¥ä¸¤ç§æ–¹å¼

4. **è§’è‰²æƒé™ç»§æ‰¿**
   - æƒé™ä¸¥æ ¼æŒ‰ç…§è§’è‰²ç­‰çº§ï¼šOwner > Admin > Member > Viewer
   - ä¸‹çº§è§’è‰²ä¸èƒ½æ“ä½œä¸Šçº§è§’è‰²çš„æƒé™
   - Owner è§’è‰²ä¸å¯å˜æ›´å’Œåˆ é™¤

## ğŸ” è§’è‰²å®šä¹‰

### ç³»ç»Ÿçº§è§’è‰²
ä»…ç”¨äºç³»ç»Ÿç®¡ç†ï¼Œä¸å‚ä¸ Family å†…éƒ¨æƒé™

| è§’è‰² | è¯´æ˜ | æƒé™èŒƒå›´ |
|-----|------|----------|
| superadmin | è¶…çº§ç®¡ç†å‘˜ | ç³»ç»Ÿæ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç®¡ç†å…¶ä»–ç”¨æˆ· |
| admin | ç³»ç»Ÿç®¡ç†å‘˜ | ç®¡ç†ç³»ç»Ÿé…ç½®ï¼Œä¸èƒ½ç®¡ç†å…¶ä»–ç®¡ç†å‘˜ |
| user | æ™®é€šç”¨æˆ· | ä½¿ç”¨ç³»ç»ŸåŠŸèƒ½ï¼Œåˆ›å»ºå’Œç®¡ç†è‡ªå·±çš„ Family |

### Family çº§è§’è‰²
ç”¨æˆ·åœ¨ç‰¹å®š Family ä¸­çš„è§’è‰²

| è§’è‰² | è¯´æ˜ | è·å¾—æ–¹å¼ | æƒé™èŒƒå›´ |
|-----|------|----------|----------|
| Owner | æ‰€æœ‰è€… | åˆ›å»º Family æ—¶è‡ªåŠ¨æˆä¸º Owner | æ‰€æœ‰æƒé™ï¼ŒåŒ…æ‹¬åˆ é™¤ Family |
| Admin | ç®¡ç†å‘˜ | Owner æˆ–å…¶ä»– Admin æŒ‡å®š | é™¤åˆ é™¤ Family å¤–çš„æ‰€æœ‰æƒé™ |
| Member | æˆå‘˜ | é»˜è®¤é‚€è¯·è§’è‰² | æŸ¥çœ‹å’Œç¼–è¾‘æ•°æ®ï¼Œä¸èƒ½ç®¡ç†æˆå‘˜ |
| Viewer | è§‚å¯Ÿè€… | ç‰¹åˆ«æŒ‡å®š | åªèƒ½æŸ¥çœ‹æ•°æ®ï¼Œä¸èƒ½ç¼–è¾‘ |

## ğŸ‘¤ ç”¨æˆ·æ³¨å†Œæµç¨‹

### åœºæ™¯ 1ï¼šè‡ªä¸»æ³¨å†Œï¼ˆæ— é‚€è¯·ï¼‰

```mermaid
graph TD
    A[ç”¨æˆ·æäº¤æ³¨å†Œä¿¡æ¯] --> B[éªŒè¯é‚®ç®±å”¯ä¸€æ€§]
    B --> C[åˆ›å»ºç”¨æˆ·è´¦å·]
    C --> D[è‡ªåŠ¨åˆ›å»ºä¸ªäººFamily]
    D --> E[è®¾ç½®ç”¨æˆ·ä¸ºFamily Owner]
    E --> F[åˆ›å»ºé»˜è®¤Ledger]
    F --> G[ç”ŸæˆJWT Token]
    G --> H[æ³¨å†Œå®Œæˆ]
```

**ä»£ç å®ç°é€»è¾‘**ï¼š
```rust
// 1. åˆ›å»ºç”¨æˆ·
let user = User {
    id: Uuid::new_v4(),
    email: request.email,
    name: request.name,
    role: "user", // ç³»ç»Ÿè§’è‰²
    ...
};

// 2. åˆ›å»ºä¸ªäºº Family
let family = Family {
    id: Uuid::new_v4(),
    name: format!("{}çš„ä¸ªäººè´¦æœ¬", user.name),
    owner_id: user.id,
    ...
};

// 3. åˆ›å»ºæˆå‘˜å…³ç³»
let membership = FamilyMembership {
    user_id: user.id,
    family_id: family.id,
    role: FamilyRole::Owner,
    ...
};

// 4. è®¾ç½®å½“å‰ Family
user.current_family_id = Some(family.id);
```

### åœºæ™¯ 2ï¼šé€šè¿‡é‚€è¯·æ³¨å†Œ

```mermaid
graph TD
    A[ç”¨æˆ·ç‚¹å‡»é‚€è¯·é“¾æ¥] --> B[æ˜¾ç¤ºæ³¨å†Œé¡µé¢]
    B --> C[éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§]
    C --> D[ç”¨æˆ·æäº¤æ³¨å†Œä¿¡æ¯]
    D --> E[åˆ›å»ºç”¨æˆ·è´¦å·]
    E --> F[åˆ›å»ºä¸ªäººFamily]
    F --> G[åŠ å…¥é‚€è¯·çš„Family]
    G --> H[è®¾ç½®å½“å‰Familyä¸ºé‚€è¯·æ–¹]
    H --> I[æ³¨å†Œå®Œæˆ]
```

**ä»£ç å®ç°é€»è¾‘**ï¼š
```rust
// 1. éªŒè¯é‚€è¯·
let invitation = verify_invitation(invite_code)?;

// 2. åˆ›å»ºç”¨æˆ·å’Œä¸ªäºº Familyï¼ˆåŒåœºæ™¯1ï¼‰
let user = create_user_with_personal_family(request);

// 3. åŠ å…¥é‚€è¯·çš„ Family
let invited_membership = FamilyMembership {
    user_id: user.id,
    family_id: invitation.family_id,
    role: invitation.role, // é‚€è¯·æ—¶æŒ‡å®šçš„è§’è‰²
    invited_by: Some(invitation.inviter_id),
    ...
};

// 4. è®¾ç½®å½“å‰ Family ä¸ºé‚€è¯·æ–¹
user.current_family_id = Some(invitation.family_id);
```

## ğŸ¤ é‚€è¯·æœºåˆ¶

### é‚€è¯·æµç¨‹

```mermaid
graph TD
    A[å‘èµ·é‚€è¯·] --> B{æ£€æŸ¥æƒé™}
    B -->|æ— æƒé™| C[æ‹’ç»]
    B -->|æœ‰æƒé™| D{è¢«é‚€è¯·è€…æ˜¯å¦å­˜åœ¨}
    D -->|å·²æ³¨å†Œ| E{æ˜¯å¦å·²åœ¨Familyä¸­}
    E -->|æ˜¯| F[æç¤ºå·²å­˜åœ¨]
    E -->|å¦| G[ç›´æ¥æ·»åŠ åˆ°Family]
    G --> H[å‘é€é€šçŸ¥é‚®ä»¶]
    D -->|æœªæ³¨å†Œ| I[ç”Ÿæˆé‚€è¯·ç ]
    I --> J[ä¿å­˜é‚€è¯·è®°å½•]
    J --> K[å‘é€é‚€è¯·é‚®ä»¶]
```

### é‚€è¯·æƒé™è§„åˆ™

| é‚€è¯·è€…è§’è‰² | å¯é‚€è¯·çš„è§’è‰² | è¯´æ˜ |
|-----------|-------------|------|
| Owner | Owner*, Admin, Member, Viewer | *éœ€è¦ç‰¹æ®Šç¡®è®¤ |
| Admin | Admin, Member, Viewer | ä¸èƒ½é‚€è¯· Owner |
| Member | æ—  | ä¸èƒ½é‚€è¯· |
| Viewer | æ—  | ä¸èƒ½é‚€è¯· |

### é‚€è¯·ç è®¾è®¡

```rust
pub struct Invitation {
    pub id: Uuid,
    pub family_id: Uuid,
    pub inviter_id: Uuid,
    pub invitee_email: String,
    pub role: FamilyRole,
    pub invite_code: String,      // 6-8ä½éšæœºç 
    pub invite_token: String,     // UUID for URL
    pub expires_at: DateTime<Utc>, // é»˜è®¤7å¤©
    pub status: InvitationStatus,
    pub created_at: DateTime<Utc>,
    pub accepted_at: Option<DateTime<Utc>>,
}

pub enum InvitationStatus {
    Pending,   // å¾…æ¥å—
    Accepted,  // å·²æ¥å—
    Expired,   // å·²è¿‡æœŸ
    Cancelled, // å·²å–æ¶ˆ
}
```

## ğŸ”‘ æƒé™çŸ©é˜µ

### ç»†ç²’åº¦æƒé™å®šä¹‰

```rust
pub enum Permission {
    // Family ç®¡ç†
    ViewFamilyInfo,
    UpdateFamilyInfo,
    DeleteFamily,
    
    // æˆå‘˜ç®¡ç†
    ViewMembers,
    InviteMembers,
    RemoveMembers,
    UpdateMemberRoles,
    
    // è´¦æˆ·æƒé™
    ViewAccounts,
    CreateAccounts,
    EditAccounts,
    DeleteAccounts,
    
    // äº¤æ˜“æƒé™
    ViewTransactions,
    CreateTransactions,
    EditTransactions,
    DeleteTransactions,
    BulkEditTransactions,
    
    // åˆ†ç±»æƒé™
    ViewCategories,
    ManageCategories,
    
    // é¢„ç®—æƒé™
    ViewBudgets,
    ManageBudgets,
    
    // æŠ¥è¡¨æƒé™
    ViewReports,
    ExportData,
    
    // é«˜çº§æƒé™
    ViewAuditLog,
    ManageIntegrations,
    ManageSettings,
}
```

### è§’è‰²é»˜è®¤æƒé™æ˜ å°„

| æƒé™ | Owner | Admin | Member | Viewer |
|------|-------|-------|---------|---------|
| **Familyç®¡ç†** |
| ViewFamilyInfo | âœ… | âœ… | âœ… | âœ… |
| UpdateFamilyInfo | âœ… | âœ… | âŒ | âŒ |
| DeleteFamily | âœ… | âŒ | âŒ | âŒ |
| **æˆå‘˜ç®¡ç†** |
| ViewMembers | âœ… | âœ… | âœ… | âœ… |
| InviteMembers | âœ… | âœ… | âŒ | âŒ |
| RemoveMembers | âœ… | âœ…* | âŒ | âŒ |
| UpdateMemberRoles | âœ… | âœ…* | âŒ | âŒ |
| **æ•°æ®æ“ä½œ** |
| View* | âœ… | âœ… | âœ… | âœ… |
| Create* | âœ… | âœ… | âœ… | âŒ |
| Edit* | âœ… | âœ… | âœ… | âŒ |
| Delete* | âœ… | âœ… | âŒ | âŒ |
| **é«˜çº§åŠŸèƒ½** |
| ExportData | âœ… | âœ… | âœ… | âŒ |
| ViewAuditLog | âœ… | âœ… | âŒ | âŒ |
| ManageSettings | âœ… | âœ… | âŒ | âŒ |

*Admin ä¸èƒ½æ“ä½œ Owner å’Œå…¶ä»– Admin

## ğŸ”„ Family åˆ‡æ¢æœºåˆ¶

### åˆ‡æ¢æµç¨‹

```rust
pub async fn switch_family(
    user_id: Uuid,
    target_family_id: Uuid,
) -> Result<ServiceContext> {
    // 1. éªŒè¯ç”¨æˆ·æ˜¯è¯¥ Family çš„æˆå‘˜
    let membership = get_membership(user_id, target_family_id)?;
    if !membership.is_active {
        return Err("Membership is not active");
    }
    
    // 2. æ›´æ–°ç”¨æˆ·çš„å½“å‰ Family
    update_user_current_family(user_id, target_family_id)?;
    
    // 3. åŠ è½½æ–°çš„æƒé™ä¸Šä¸‹æ–‡
    let permissions = get_permissions_for_role(membership.role);
    
    // 4. ç”Ÿæˆæ–°çš„ JWT Tokenï¼ˆåŒ…å«æ–°çš„ family_id å’Œæƒé™ï¼‰
    let new_token = generate_token_with_context(
        user_id,
        target_family_id,
        membership.role,
        permissions,
    );
    
    // 5. è¿”å›æ–°çš„ä¸Šä¸‹æ–‡
    Ok(ServiceContext {
        user_id,
        family_id: target_family_id,
        role: membership.role,
        permissions,
        token: new_token,
    })
}
```

## ğŸ“Š å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šä¸ªäººç†è´¢ç”¨æˆ·
```
å¼ ä¸‰æ³¨å†Œ â†’ è‡ªåŠ¨åˆ›å»º"å¼ ä¸‰çš„ä¸ªäººè´¦æœ¬"(Owner)
ä½¿ç”¨ä¸ªäººè´¦æœ¬è®°å½•æ—¥å¸¸å¼€æ”¯
æ— éœ€é‚€è¯·ä»–äººï¼Œç‹¬ç«‹ä½¿ç”¨
```

### åœºæ™¯ 2ï¼šå®¶åº­å…±åŒç†è´¢
```
1. çˆ¸çˆ¸æ³¨å†Œ â†’ åˆ›å»º"çˆ¸çˆ¸çš„ä¸ªäººè´¦æœ¬"(Owner)
2. çˆ¸çˆ¸åˆ›å»º"å®¶åº­è´¦æœ¬" â†’ æˆä¸ºOwner
3. çˆ¸çˆ¸é‚€è¯·å¦ˆå¦ˆ(Admin) â†’ å¦ˆå¦ˆå¯ä»¥ç®¡ç†è´¦æœ¬
4. çˆ¸çˆ¸é‚€è¯·å­©å­(Member) â†’ å­©å­å¯ä»¥è®°è´¦
5. æ¯ä¸ªäººéƒ½æœ‰ï¼š
   - è‡ªå·±çš„ä¸ªäººè´¦æœ¬(Owner)
   - å®¶åº­è´¦æœ¬(ä¸åŒè§’è‰²)
```

### åœºæ™¯ 3ï¼šå°å›¢é˜Ÿè´¢åŠ¡ç®¡ç†
```
1. åˆ›å§‹äººæ³¨å†Œ â†’ åˆ›å»º"å…¬å¸è´¦æœ¬"(Owner)
2. é‚€è¯·è´¢åŠ¡(Admin) â†’ å…¨æƒç®¡ç†
3. é‚€è¯·å‘˜å·¥(Member) â†’ æäº¤æŠ¥é”€
4. é‚€è¯·è€æ¿(Viewer) â†’ åªçœ‹æŠ¥è¡¨
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### æƒé™æ£€æŸ¥åŸåˆ™

1. **æ¯ä¸ª API è¯·æ±‚éƒ½è¦æ£€æŸ¥æƒé™**
   ```rust
   // åœ¨ handler å±‚
   context.require_permission(Permission::CreateTransactions)?;
   ```

2. **æ•°æ®æŸ¥è¯¢è‡ªåŠ¨åŠ å…¥ Family è¿‡æ»¤**
   ```rust
   // åœ¨ repository å±‚
   query.filter(family_id.eq(context.family_id))
   ```

3. **é˜²æ­¢è¶Šæƒæ“ä½œ**
   ```rust
   // ä¸èƒ½æ“ä½œæ›´é«˜çº§åˆ«çš„è§’è‰²
   if target_role >= operator_role {
       return Err("Cannot operate on higher or equal role");
   }
   ```

4. **æ•æ„Ÿæ“ä½œäºŒæ¬¡ç¡®è®¤**
   - åˆ é™¤ Family
   - è½¬ç§» Owner æƒé™
   - æ‰¹é‡åˆ é™¤æ•°æ®

## ğŸš€ å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€æ¶æ„ï¼ˆç¬¬1-2å¤©ï¼‰
- âœ… æ•°æ®åº“ç»“æ„è°ƒæ•´
- âœ… é¢†åŸŸæ¨¡å‹å®šä¹‰
- âœ… åŸºç¡€æœåŠ¡æ¡†æ¶

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆç¬¬3-4å¤©ï¼‰
- âœ… ç”¨æˆ·æ³¨å†Œæµç¨‹æ”¹é€ 
- âœ… Family CRUD
- âœ… åŸºç¡€é‚€è¯·æœºåˆ¶

### Phase 3: æƒé™ç³»ç»Ÿï¼ˆç¬¬5å¤©ï¼‰
- âœ… æƒé™ä¸­é—´ä»¶
- âœ… è§’è‰²æƒé™æ˜ å°„
- âœ… API æƒé™ä¿æŠ¤

### Phase 4: å®Œå–„åŠŸèƒ½ï¼ˆç¬¬6-7å¤©ï¼‰
- âœ… Family åˆ‡æ¢
- âœ… æ™ºèƒ½é‚€è¯·
- âœ… æ•°æ®éš”ç¦»

### Phase 5: æµ‹è¯•ä¼˜åŒ–ï¼ˆç¬¬8å¤©ï¼‰
- âœ… å•å…ƒæµ‹è¯•
- âœ… é›†æˆæµ‹è¯•
- âœ… æ–‡æ¡£å®Œå–„

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**
   - ç°æœ‰ç”¨æˆ·æ•°æ®éœ€è¦è¿ç§»è„šæœ¬
   - ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºé»˜è®¤ Family

2. **æ€§èƒ½ä¼˜åŒ–**
   - Family ä¿¡æ¯ç¼“å­˜
   - æƒé™ç¼“å­˜
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢

3. **ç”¨æˆ·ä½“éªŒ**
   - æ¸…æ™°çš„è§’è‰²æ ‡è¯†
   - ä¾¿æ·çš„ Family åˆ‡æ¢
   - å‹å¥½çš„é‚€è¯·æµç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-09-03  
**ä½œè€…**: Jive å¼€å‘å›¢é˜Ÿ